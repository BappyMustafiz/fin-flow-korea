{% extends "layout.html" %}

{% block title %}거래 내역 - Vlan24{% endblock %}

{% block extra_css %}
<style>
.transaction-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #e3e6f0;
}

.transaction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
}

.transaction-icon i {
    width: 20px;
    height: 20px;
}

.view-options .btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.badge-status-pending {
    background-color: #6c757d;
    color: white;
}

.badge-status-classified {
    background-color: #28a745;
    color: white;
}

.badge-status-manual {
    background-color: #007bff;
    color: white;
}

#grid-view .btn-group {
    flex-direction: column;
}

#grid-view .btn-group .btn {
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
}

#grid-view .btn-group .btn:last-child {
    margin-bottom: 0;
}

#grid-view .transaction-card {
    min-height: 280px;
    max-height: 300px;
}

#grid-view .card-body {
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* 자동 반응형 그리드 - 카드 최소/최대 크기 기준으로 자동 조정 */
#grid-view {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(200px, 300px)) !important;
    gap: 1rem !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    justify-content: start !important;
}

#grid-view .grid-item {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
}

/* 작은 화면에서는 최소 크기 조정 */
@media (max-width: 768px) {
    #grid-view {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
    }
}

@media (max-width: 480px) {
    #grid-view {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">거래 내역</h1>
        {% if selected_account %}
            <p class="text-muted mb-0">
                <strong>{{ selected_account.institution.name }}</strong> - {{ selected_account.account_name }} 
                ({{ selected_account.account_number }}) 계좌의 거래 내역
            </p>
            <div class="mb-3">
                <a href="{{ url_for('transactions') }}" class="btn btn-sm btn-outline-secondary">
                    <i data-feather="arrow-left" class="me-1"></i>전체 거래내역 보기
                </a>
            </div>
        {% else %}
            <p class="text-muted mb-0">거래 내역 조회 및 분류 관리</p>
        {% endif %}
    </div>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
            <i data-feather="plus" class="me-2"></i>{{ get_text('add_transaction') }}
        </button>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-2">
                        <label for="status" class="form-label">분류상태</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">전체</option>
                            <option value="pending" {% if current_filters.status == 'pending' %}selected{% endif %}>미분류</option>
                            <option value="classified" {% if current_filters.status == 'classified' %}selected{% endif %}>자동분류</option>
                            <option value="manual" {% if current_filters.status == 'manual' %}selected{% endif %}>수동분류</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="department_id" class="form-label">부서</label>
                        <select class="form-select" id="department_id" name="department_id">
                            <option value="">전체</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if current_filters.department_id == dept.id|string %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="account_id" class="form-label">계좌</label>
                        <select class="form-select" id="account_id" name="account_id">
                            <option value="">전체 계좌</option>
                            {% for account in accounts %}
                                <option value="{{ account.id }}" {% if current_filters.account_id == account.id|string %}selected{% endif %}>
                                    {{ account.institution.name }} - {{ account.account_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="category_id" class="form-label">카테고리</label>
                        <select class="form-select" id="category_id" name="category_id">
                            <option value="">전체</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if current_filters.category_id == cat.id|string %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="search" class="form-label">검색</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="거래처명, 거래내용 검색" value="{{ current_filters.search }}">
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="search" class="me-1"></i>검색
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="bulk-actions" style="display: none;">
                <span class="text-muted me-3">선택된 항목: <span id="selectedCount">0</span>개</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="bulkClassify()">
                        <i data-feather="tag" class="me-1"></i>일괄 분류
                    </button>
                    <button class="btn btn-outline-secondary" onclick="bulkExport()">
                        <i data-feather="download" class="me-1"></i>내보내기
                    </button>
                </div>
            </div>
            
            <div class="view-options">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" data-view="list" onclick="switchView('list')">
                        <i data-feather="list"></i>
                    </button>
                    <button class="btn btn-outline-secondary" data-view="grid" onclick="switchView('grid')">
                        <i data-feather="grid"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transactions List View -->
<div class="row" id="list-view">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>기본정보</th>
                                <th>기간</th>
                                <th>추가정보</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input transaction-checkbox" 
                                           value="{{ transaction.id }}">
                                </td>
                                <td>
                                    <div class="transaction-basic">
                                        <!-- 거래처 정보 -->
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="transaction-icon me-3">
                                                {% if transaction.amount > 0 %}
                                                    <i data-feather="arrow-down-right" class="text-success"></i>
                                                {% else %}
                                                    <i data-feather="arrow-up-right" class="text-danger"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ transaction.counterparty or '(거래처 미상)' }}</strong>
                                                <br>
                                                <small class="text-muted">{{ transaction.account.institution.name }}</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 거래 내용 -->
                                        <div class="transaction-desc mb-2">
                                            {{ transaction.description }}
                                        </div>
                                        
                                        <!-- 금액 -->
                                        <div class="transaction-amount">
                                            <span class="h5 {{ transaction.amount | amount_color }}">
                                                {{ transaction.amount | currency }}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="transaction-period">
                                        <!-- 거래일자 -->
                                        <div class="mb-1">
                                            <strong>{{ transaction.transaction_date.strftime('%Y-%m-%d') }}</strong>
                                        </div>
                                        <div class="text-muted small">
                                            {{ transaction.transaction_date.strftime('%H:%M') }}
                                        </div>
                                        
                                        <!-- 처리일자 -->
                                        {% if transaction.processed_date %}
                                        <div class="text-muted small mt-1">
                                            처리: {{ transaction.processed_date.strftime('%m/%d') }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="transaction-additional">
                                        <!-- 분류 정보 -->
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="badge badge-status-{{ transaction.classification_status }} me-2">
                                                    {{ transaction.classification_status | classification_status }}
                                                </span>
                                            </div>
                                            
                                            {% if transaction.category %}
                                                <div class="small text-muted">
                                                    <i data-feather="tag" class="me-1" style="width: 12px; height: 12px;"></i>
                                                    {{ transaction.category.name }}
                                                </div>
                                            {% endif %}
                                            
                                            {% if transaction.department %}
                                                <div class="small text-muted">
                                                    <i data-feather="users" class="me-1" style="width: 12px; height: 12px;"></i>
                                                    {{ transaction.department.name }}
                                                </div>
                                            {% endif %}
                                            
                                            {% if transaction.vendor %}
                                                <div class="small text-muted">
                                                    <i data-feather="briefcase" class="me-1" style="width: 12px; height: 12px;"></i>
                                                    {{ transaction.vendor.name }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" 
                                           class="btn btn-outline-primary" title="편집">
                                            <i data-feather="edit"></i>
                                        </a>
                                        <button class="btn btn-outline-secondary" 
                                                onclick="splitTransaction({{ transaction.id }})" 
                                                title="분할">
                                            <i data-feather="scissors"></i>
                                        </button>
                                        <button class="btn btn-outline-info" 
                                                onclick="viewDetails({{ transaction.id }})" 
                                                title="상세">
                                            <i data-feather="eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteTransaction({{ transaction.id }}, '{{ transaction.description | replace("'", "\\'") }}')" 
                                                title="삭제">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    조건에 맞는 거래 내역이 없습니다.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Grid View -->
<div id="grid-view" class="grid-container" style="display: none;">
    {% for transaction in transactions %}
    <div class="grid-item">
        <div class="card h-100 transaction-card">
            <div class="card-body">
                <!-- 체크박스와 거래처 정보 -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input transaction-checkbox" 
                               value="{{ transaction.id }}">
                    </div>
                    <div class="transaction-icon">
                        {% if transaction.amount > 0 %}
                            <i data-feather="arrow-down-right" class="text-success"></i>
                        {% else %}
                            <i data-feather="arrow-up-right" class="text-danger"></i>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 거래처 및 설명 -->
                <div class="mb-2">
                    <h6 class="card-title mb-1 text-truncate" style="font-size: 0.9rem;">{{ transaction.counterparty or '(거래처 미상)' }}</h6>
                    <p class="card-text text-muted mb-1" style="font-size: 0.75rem; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ transaction.description }}</p>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ transaction.account.institution.name }}</small>
                </div>
                
                <!-- 금액 -->
                <div class="mb-2 text-center">
                    <span class="h6 {{ transaction.amount | amount_color }}">
                        {{ transaction.amount | currency }}
                    </span>
                </div>
                
                <!-- 날짜 정보 -->
                <div class="mb-2 text-center">
                    <div class="fw-bold" style="font-size: 0.8rem;">{{ transaction.transaction_date.strftime('%m/%d') }}</div>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ transaction.transaction_date.strftime('%H:%M') }}</small>
                </div>
                
                <!-- 분류 정보 -->
                <div class="mb-2 text-center">
                    <span class="badge badge-status-{{ transaction.classification_status }}" style="font-size: 0.65rem;">
                        {{ transaction.classification_status | classification_status }}
                    </span>
                </div>
                
                <!-- 작업 버튼 -->
                <div class="d-grid">
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" 
                           class="btn btn-outline-primary btn-sm" title="편집">
                            <i data-feather="edit" style="width: 12px; height: 12px;"></i>
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" 
                                onclick="splitTransaction({{ transaction.id }})" 
                                title="분할">
                            <i data-feather="scissors" style="width: 12px; height: 12px;"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" 
                                onclick="viewDetails({{ transaction.id }})" 
                                title="상세">
                            <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" 
                                onclick="deleteTransaction({{ transaction.id }}, '{{ transaction.description | replace("'", "\\'") }}')" 
                                title="삭제">
                            <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="text-center text-muted py-4">
            조건에 맞는 거래 내역이 없습니다.
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="거래 내역 페이지네이션">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('transactions', page=pagination.prev_num, **current_filters) }}">이전</a>
                    </li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transactions', page=page_num, **current_filters) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('transactions', page=pagination.next_num, **current_filters) }}">다음</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

<!-- Bulk Classify Modal -->
<div class="modal fade" id="bulkClassifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">일괄 분류</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="#">
                <div class="modal-body">
                    <p class="text-muted">선택된 <span id="bulkSelectedCount">0</span>개 거래를 일괄 분류합니다.</p>
                    
                    <div class="mb-3">
                        <label for="bulkCategory" class="form-label">카테고리</label>
                        <select class="form-select" id="bulkCategory" name="category_id">
                            <option value="">선택하세요</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulkDepartment" class="form-label">부서</label>
                        <select class="form-select" id="bulkDepartment" name="department_id">
                            <option value="">선택하세요</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">적용</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Split Modal -->
<div class="modal fade" id="transactionSplitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">거래 분할</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="" id="splitForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">원본 거래 정보</label>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div id="originalTransactionInfo">
                                    <!-- 원본 거래 정보가 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">분할할 항목 수</label>
                        <select class="form-select" id="splitCount" onchange="generateSplitItems()">
                            <option value="2">2개로 분할</option>
                            <option value="3">3개로 분할</option>
                            <option value="4">4개로 분할</option>
                            <option value="5">5개로 분할</option>
                        </select>
                    </div>
                    
                    <div id="splitItems">
                        <!-- 분할 항목들이 동적으로 생성됩니다 -->
                    </div>
                    
                    <div class="alert alert-info">
                        <i data-feather="info" class="me-2"></i>
                        분할된 금액의 합계는 원본 거래 금액과 일치해야 합니다.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="scissors" class="me-1"></i>분할 실행
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">거래 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailsContent">
                    <!-- 동적으로 로드 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 전체 선택 체크박스
    const selectAllCheckbox = document.getElementById('selectAll');
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    const bulkActionsDiv = document.querySelector('.bulk-actions');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    selectAllCheckbox.addEventListener('change', function() {
        transactionCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });
    
    transactionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCountSpan.textContent = count;
        
        if (count > 0) {
            bulkActionsDiv.style.display = 'block';
        } else {
            bulkActionsDiv.style.display = 'none';
        }
        
        // 전체 선택 체크박스 상태 업데이트
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === transactionCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
});

function bulkClassify() {
    const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
    const count = checkedBoxes.length;
    
    if (count === 0) {
        alert('분류할 거래를 선택해 주세요.');
        return;
    }
    
    document.getElementById('bulkSelectedCount').textContent = count;
    const modal = new bootstrap.Modal(document.getElementById('bulkClassifyModal'));
    modal.show();
}

function bulkExport() {
    const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        alert('내보낼 거래를 선택해 주세요.');
        return;
    }
    
    // 내보내기 로직
    const ids = Array.from(checkedBoxes).map(cb => cb.value);
    console.log('Exporting transactions:', ids);
}

// 보기 전환 함수
function switchView(view) {
    const listView = document.getElementById('list-view');
    const gridView = document.getElementById('grid-view');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (view === 'list') {
        listView.style.display = 'block';
        gridView.style.display = 'none';
        gridView.classList.remove('grid-container');
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
        
        // 로컬스토리지에 보기 설정 저장
        localStorage.setItem('transactionView', 'list');
    } else if (view === 'grid') {
        listView.style.display = 'none';
        gridView.style.display = 'grid';
        gridView.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 300px))';
        gridView.style.gap = '1rem';
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
        
        // 로컬스토리지에 보기 설정 저장
        localStorage.setItem('transactionView', 'grid');
    }
    
    // Feather 아이콘 다시 렌더링
    feather.replace();
}

// 페이지 로드 시 저장된 보기 설정 적용 (기본값: 리스트)
document.addEventListener('DOMContentLoaded', function() {
    const savedView = localStorage.getItem('transactionView') || 'list';
    // 첫 방문 시에는 항상 리스트 뷰로 시작
    if (!localStorage.getItem('transactionView')) {
        switchView('list');
    } else {
        switchView(savedView);
    }
});

// 거래 분할 관련 전역 변수
let currentTransactionId = null;
let originalTransactionAmount = 0;

function splitTransaction(transactionId) {
    currentTransactionId = transactionId;
    
    // 원본 거래 정보 가져오기
    fetch(`/transaction/${transactionId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayOriginalTransaction(data.transaction);
                originalTransactionAmount = data.transaction.amount;
                generateSplitItems(); // 기본 2개 분할로 시작
                
                // 폼의 액션 URL 설정
                document.getElementById('splitForm').action = `/transaction/${transactionId}/split`;
                
                const modal = new bootstrap.Modal(document.getElementById('transactionSplitModal'));
                modal.show();
            } else {
                alert('거래 정보를 불러올 수 없습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('거래 정보를 불러오는 중 오류가 발생했습니다.');
        });
}

function displayOriginalTransaction(transaction) {
    const originalInfo = document.getElementById('originalTransactionInfo');
    const amountClass = transaction.amount > 0 ? 'text-success' : 'text-danger';
    const amountText = transaction.amount > 0 ? `+${Math.abs(transaction.amount).toLocaleString()}원` : `-${Math.abs(transaction.amount).toLocaleString()}원`;
    
    originalInfo.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong>거래처:</strong> ${transaction.counterparty || '(거래처 미상)'}<br>
                <strong>거래내용:</strong> ${transaction.description}<br>
                <strong>거래일시:</strong> ${new Date(transaction.transaction_date).toLocaleDateString()}
            </div>
            <div class="col-md-6">
                <strong>금액:</strong> <span class="${amountClass}">${amountText}</span><br>
                <strong>계좌:</strong> ${transaction.account.institution.name} - ${transaction.account.account_name}<br>
                <strong>분류상태:</strong> ${getClassificationStatusText(transaction.classification_status)}
            </div>
        </div>
    `;
}

function generateSplitItems() {
    const splitCount = parseInt(document.getElementById('splitCount').value);
    const splitItemsContainer = document.getElementById('splitItems');
    const suggestedAmount = Math.floor(originalTransactionAmount / splitCount);
    
    let html = '<div class="row g-3">';
    
    for (let i = 1; i <= splitCount; i++) {
        html += `
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">분할 항목 ${i}</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label">금액</label>
                            <input type="number" class="form-control split-amount" name="amounts[]" 
                                   value="${suggestedAmount}" step="0.01" onchange="updateTotal()">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">거래내용</label>
                            <input type="text" class="form-control" name="descriptions[]" 
                                   placeholder="분할 거래 설명">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">카테고리</label>
                            <select class="form-select" name="categories[]">
                                <option value="">선택하세요</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">부서</label>
                            <select class="form-select" name="departments[]">
                                <option value="">선택하세요</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    html += `
        <div class="mt-3">
            <div class="row">
                <div class="col-md-6">
                    <strong>원본 금액:</strong> <span class="text-muted">${originalTransactionAmount.toLocaleString()}원</span>
                </div>
                <div class="col-md-6">
                    <strong>분할 합계:</strong> <span id="splitTotal" class="text-danger">0원</span>
                </div>
            </div>
        </div>
    `;
    
    splitItemsContainer.innerHTML = html;
    updateTotal();
}

function updateTotal() {
    const amountInputs = document.querySelectorAll('.split-amount');
    let total = 0;
    
    amountInputs.forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    
    const totalElement = document.getElementById('splitTotal');
    totalElement.textContent = total.toLocaleString() + '원';
    
    if (Math.abs(total - originalTransactionAmount) < 0.01) {
        totalElement.className = 'text-success';
    } else {
        totalElement.className = 'text-danger';
    }
}

function getClassificationStatusText(status) {
    const statusMap = {
        'pending': '미분류',
        'classified': '자동분류',
        'manual': '수동분류'
    };
    return statusMap[status] || status;
}

function viewDetails(transactionId) {
    // 거래 상세 정보 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
    
    // 상세 정보 로드 (실제로는 AJAX 호출)
    document.getElementById('transactionDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // 실제 거래 상세 정보 가져오기
    fetch(`/transaction/${transactionId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const transaction = data.transaction;
                document.getElementById('transactionDetailsContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>기본 정보</h6>
                            <table class="table table-sm">
                                <tr><td>거래 ID:</td><td>${transaction.id}</td></tr>
                                <tr><td>거래일시:</td><td>${new Date(transaction.transaction_date).toLocaleString('ko-KR')}</td></tr>
                                <tr><td>거래처:</td><td>${transaction.counterparty || '-'}</td></tr>
                                <tr><td>금액:</td><td class="${transaction.amount < 0 ? 'text-danger' : 'text-success'}">${transaction.amount.toLocaleString()}원</td></tr>
                                <tr><td>계좌:</td><td>${transaction.account ? transaction.account.account_name : '-'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>거래 설명</h6>
                            <p class="text-muted">${transaction.description || '-'}</p>
                            <h6>분류 상태</h6>
                            <span class="badge ${transaction.classification_status === 'classified' ? 'bg-success' : transaction.classification_status === 'manual' ? 'bg-primary' : 'bg-secondary'}">
                                ${transaction.classification_status === 'classified' ? '자동분류' : transaction.classification_status === 'manual' ? '수동분류' : '미분류'}
                            </span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('transactionDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i data-feather="alert-circle" class="me-2"></i>
                        거래 정보를 불러올 수 없습니다: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('transactionDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i data-feather="alert-circle" class="me-2"></i>
                    거래 정보 로드 중 오류가 발생했습니다.
                </div>
            `;
        });
}

// 거래 삭제 함수
function deleteTransaction(transactionId, transactionDescription) {
    if (!confirm(`'${transactionDescription}' 거래를 삭제하시겠습니까?\n\n주의: 이 작업은 되돌릴 수 없습니다.`)) {
        return;
    }
    
    const resultsContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-4');
    
    // 결과 표시 영역이 없으면 생성
    let resultsDiv = document.getElementById('transactionResults');
    if (!resultsDiv) {
        resultsDiv = document.createElement('div');
        resultsDiv.id = 'transactionResults';
        resultsDiv.style.display = 'none';
        resultsContainer.parentNode.insertBefore(resultsDiv, resultsContainer.nextSibling);
    }
    
    resultsDiv.innerHTML = `
        <div class="alert alert-info">
            <i data-feather="loader" class="me-2"></i>거래 삭제 중...
        </div>
    `;
    resultsDiv.style.display = 'block';
    
    fetch(`/transaction/${transactionId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <i data-feather="check-circle" class="me-2"></i>
                    거래가 성공적으로 삭제되었습니다.
                </div>
            `;
            // 페이지 새로고침으로 목록 업데이트
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i data-feather="alert-circle" class="me-2"></i>
                    삭제 실패: ${data.error}
                </div>
            `;
        }
        feather.replace();
        
        // 3초 후 결과 메시지 숨기기
        setTimeout(() => {
            resultsDiv.style.display = 'none';
        }, 3000);
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i data-feather="alert-circle" class="me-2"></i>
                삭제 중 오류가 발생했습니다.
            </div>
        `;
        feather.replace();
        
        setTimeout(() => {
            resultsDiv.style.display = 'none';
        }, 3000);
    });
}
</script>

<!-- 거래 추가 모달 -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ get_text('add_transaction') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_transaction') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="account_id" class="form-label">계정 선택 *</label>
                        <select class="form-select" id="account_id" name="account_id" required>
                            <option value="">계정을 선택하세요</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">{{ account.name }} ({{ account.institution.name if account.institution else '' }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_type" class="form-label">{{ get_text('transaction_type') }} *</label>
                        <select class="form-select" id="transaction_type" name="transaction_type" required onchange="updateTransactionTypeFields()">
                            <option value="">거래 유형을 선택하세요</option>
                            <option value="deposit">{{ get_text('deposit') }}</option>
                            <option value="withdrawal">{{ get_text('withdrawal') }}</option>
                            <option value="transfer">{{ get_text('transfer') }}</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction_date" class="form-label">{{ get_text('transaction_date') }} *</label>
                        <input type="datetime-local" class="form-control" id="transaction_date" name="transaction_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">{{ get_text('amount') }} (원) *</label>
                        <input type="text" class="form-control" id="amount" name="amount" required placeholder="예: 10,000" oninput="formatAmount(this)">
                        <input type="hidden" id="amount_value" name="amount_value">
                    </div>
                    
                    <div class="mb-3">
                        <label for="counterparty_type" class="form-label">{{ get_text('counterparty') }} *</label>
                        <div class="row">
                            <div class="col-md-4">
                                <select class="form-select" id="counterparty_type" onchange="updateCounterpartyField()">
                                    <option value="existing">기존 업체</option>
                                    <option value="new">새 업체</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <select class="form-select" id="counterparty_existing" name="counterparty">
                                    <option value="">업체를 선택하세요</option>
                                    {% for vendor in vendors %}
                                    <option value="{{ vendor.name }}">{{ vendor.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control" id="counterparty_new" name="counterparty" style="display: none;" placeholder="새 업체명을 입력하세요">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">{{ get_text('memo') }}</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="거래 내용을 입력하세요"></textarea>
                    </div>
                    
                    <!-- 이체 전용 필드 -->
                    <div id="transferFields" style="display: none;">
                        <div class="alert alert-info">
                            <i data-feather="info" class="me-2"></i>
                            이체 거래는 통계 및 예산 관리에서 제외됩니다.
                        </div>
                        <div class="mb-3">
                            <label for="target_account_id" class="form-label">받는 계정</label>
                            <select class="form-select" id="target_account_id" name="target_account_id">
                                <option value="">받는 계정을 선택하세요</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}">{{ account.name }} ({{ account.institution.name if account.institution else '' }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- 분류 정보 (이체가 아닌 경우만) -->
                    <div id="classificationFields">
                        <hr>
                        <h6>분류 정보 (선택사항)</h6>
                        
                        <div class="mb-3">
                            <label for="category_id" class="form-label">분류</label>
                            <select class="form-select" id="category_id" name="category_id">
                                <option value="">분류를 선택하세요</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="department_id" class="form-label">부서</label>
                            <select class="form-select" id="department_id" name="department_id">
                                <option value="">부서를 선택하세요</option>
                                {% for department in departments %}
                                <option value="{{ department.id }}">{{ department.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vendor_id" class="form-label">업체</label>
                            <select class="form-select" id="vendor_id" name="vendor_id">
                                <option value="">업체를 선택하세요</option>
                                {% for vendor in vendors %}
                                <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ get_text('cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ get_text('add') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 거래 유형에 따라 필드 표시/숨김
function updateTransactionTypeFields() {
    const transactionType = document.getElementById('transaction_type').value;
    const transferFields = document.getElementById('transferFields');
    const classificationFields = document.getElementById('classificationFields');
    
    if (transactionType === 'transfer') {
        transferFields.style.display = 'block';
        classificationFields.style.display = 'none';
    } else {
        transferFields.style.display = 'none';
        classificationFields.style.display = 'block';
    }
}

// 금액 천단위 콤마 포맷팅
function formatAmount(input) {
    // 숫자만 추출
    let value = input.value.replace(/[^\d]/g, '');
    
    if (value === '') {
        input.value = '';
        document.getElementById('amount_value').value = '';
        return;
    }
    
    // 천단위 콤마 추가
    const formatted = parseInt(value).toLocaleString('ko-KR');
    input.value = formatted;
    
    // 실제 숫자 값을 hidden 필드에 저장
    document.getElementById('amount_value').value = value;
}

// 폼 제출 시 콤마 제거된 값으로 설정
document.querySelector('#addTransactionModal form').addEventListener('submit', function(e) {
    const amountInput = document.getElementById('amount');
    const amountValue = document.getElementById('amount_value').value;
    
    if (amountValue) {
        // 실제 숫자 값으로 설정
        amountInput.name = 'amount';
        amountInput.value = amountValue;
        document.getElementById('amount_value').name = '';
    }
});

// 업체명 선택 방식 변경
function updateCounterpartyField() {
    const counterpartyType = document.getElementById('counterparty_type').value;
    const existingSelect = document.getElementById('counterparty_existing');
    const newInput = document.getElementById('counterparty_new');
    
    if (counterpartyType === 'existing') {
        existingSelect.style.display = 'block';
        newInput.style.display = 'none';
        existingSelect.required = true;
        newInput.required = false;
    } else {
        existingSelect.style.display = 'none';
        newInput.style.display = 'block';
        existingSelect.required = false;
        newInput.required = true;
    }
}

// 모달이 열릴 때 현재 시간으로 설정
document.getElementById('addTransactionModal').addEventListener('show.bs.modal', function () {
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('transaction_date').value = localDateTime;
    
    // 금액 필드 초기화
    document.getElementById('amount').value = '';
    document.getElementById('amount_value').value = '';
    
    // 업체명 필드 초기화
    document.getElementById('counterparty_type').value = 'existing';
    updateCounterpartyField();
});
</script>
{% endblock %}
