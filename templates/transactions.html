{% extends "layout.html" %}

{% block title %}거래 내역 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block extra_css %}
<style>
.transaction-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #e3e6f0;
}

.transaction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
}

.transaction-icon i {
    width: 20px;
    height: 20px;
}

.view-options .btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.badge-status-pending {
    background-color: #6c757d;
    color: white;
}

.badge-status-classified {
    background-color: #28a745;
    color: white;
}

.badge-status-manual {
    background-color: #007bff;
    color: white;
}

#grid-view .btn-group {
    flex-direction: column;
}

#grid-view .btn-group .btn {
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
}

#grid-view .btn-group .btn:last-child {
    margin-bottom: 0;
}

#grid-view .transaction-card {
    min-height: 280px;
    max-height: 300px;
}

#grid-view .card-body {
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#grid-view {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 1rem !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
}

#grid-view .grid-item {
    flex: 0 0 calc(20% - 0.8rem) !important;
    width: calc(20% - 0.8rem) !important;
    max-width: calc(20% - 0.8rem) !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
}

/* 반응형 */
@media (max-width: 1399px) {
    #grid-view .grid-item {
        flex: 0 0 calc(25% - 0.75rem) !important;
        width: calc(25% - 0.75rem) !important;
        max-width: calc(25% - 0.75rem) !important;
    }
}

@media (max-width: 1199px) {
    #grid-view .grid-item {
        flex: 0 0 calc(33.333% - 0.67rem) !important;
        width: calc(33.333% - 0.67rem) !important;
        max-width: calc(33.333% - 0.67rem) !important;
    }
}

@media (max-width: 767px) {
    #grid-view .grid-item {
        flex: 0 0 calc(50% - 0.5rem) !important;
        width: calc(50% - 0.5rem) !important;
        max-width: calc(50% - 0.5rem) !important;
    }
}

@media (max-width: 575px) {
    #grid-view .grid-item {
        flex: 0 0 100% !important;
        width: 100% !important;
        max-width: 100% !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">거래 내역</h1>
        {% if selected_account %}
            <p class="text-muted">
                <strong>{{ selected_account.institution.name }}</strong> - {{ selected_account.account_name }} 
                ({{ selected_account.account_number }}) 계좌의 거래 내역
            </p>
            <div class="mb-3">
                <a href="{{ url_for('transactions') }}" class="btn btn-sm btn-outline-secondary">
                    <i data-feather="arrow-left" class="me-1"></i>전체 거래내역 보기
                </a>
            </div>
        {% else %}
            <p class="text-muted">거래 내역 조회 및 분류 관리</p>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-2">
                        <label for="status" class="form-label">분류상태</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">전체</option>
                            <option value="pending" {% if current_filters.status == 'pending' %}selected{% endif %}>미분류</option>
                            <option value="classified" {% if current_filters.status == 'classified' %}selected{% endif %}>자동분류</option>
                            <option value="manual" {% if current_filters.status == 'manual' %}selected{% endif %}>수동분류</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="department_id" class="form-label">부서</label>
                        <select class="form-select" id="department_id" name="department_id">
                            <option value="">전체</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if current_filters.department_id == dept.id|string %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="account_id" class="form-label">계좌</label>
                        <select class="form-select" id="account_id" name="account_id">
                            <option value="">전체 계좌</option>
                            {% for account in accounts %}
                                <option value="{{ account.id }}" {% if current_filters.account_id == account.id|string %}selected{% endif %}>
                                    {{ account.institution.name }} - {{ account.account_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="category_id" class="form-label">카테고리</label>
                        <select class="form-select" id="category_id" name="category_id">
                            <option value="">전체</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if current_filters.category_id == cat.id|string %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="search" class="form-label">검색</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="거래처명, 거래내용 검색" value="{{ current_filters.search }}">
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="search" class="me-1"></i>검색
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="bulk-actions" style="display: none;">
                <span class="text-muted me-3">선택된 항목: <span id="selectedCount">0</span>개</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="bulkClassify()">
                        <i data-feather="tag" class="me-1"></i>일괄 분류
                    </button>
                    <button class="btn btn-outline-secondary" onclick="bulkExport()">
                        <i data-feather="download" class="me-1"></i>내보내기
                    </button>
                </div>
            </div>
            
            <div class="view-options">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" data-view="list" onclick="switchView('list')">
                        <i data-feather="list"></i>
                    </button>
                    <button class="btn btn-outline-secondary" data-view="grid" onclick="switchView('grid')">
                        <i data-feather="grid"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transactions List View -->
<div class="row" id="list-view">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>기본정보</th>
                                <th>기간</th>
                                <th>추가정보</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input transaction-checkbox" 
                                           value="{{ transaction.id }}">
                                </td>
                                <td>
                                    <div class="transaction-basic">
                                        <!-- 거래처 정보 -->
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="transaction-icon me-3">
                                                {% if transaction.amount > 0 %}
                                                    <i data-feather="arrow-down-right" class="text-success"></i>
                                                {% else %}
                                                    <i data-feather="arrow-up-right" class="text-danger"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ transaction.counterparty or '(거래처 미상)' }}</strong>
                                                <br>
                                                <small class="text-muted">{{ transaction.account.institution.name }}</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 거래 내용 -->
                                        <div class="transaction-desc mb-2">
                                            {{ transaction.description }}
                                        </div>
                                        
                                        <!-- 금액 -->
                                        <div class="transaction-amount">
                                            <span class="h5 {{ transaction.amount | amount_color }}">
                                                {{ transaction.amount | currency }}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="transaction-period">
                                        <!-- 거래일자 -->
                                        <div class="mb-1">
                                            <strong>{{ transaction.transaction_date.strftime('%Y-%m-%d') }}</strong>
                                        </div>
                                        <div class="text-muted small">
                                            {{ transaction.transaction_date.strftime('%H:%M') }}
                                        </div>
                                        
                                        <!-- 처리일자 -->
                                        {% if transaction.processed_date %}
                                        <div class="text-muted small mt-1">
                                            처리: {{ transaction.processed_date.strftime('%m/%d') }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="transaction-additional">
                                        <!-- 분류 정보 -->
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center mb-1">
                                                <span class="badge badge-status-{{ transaction.classification_status }} me-2">
                                                    {{ transaction.classification_status | classification_status }}
                                                </span>
                                            </div>
                                            
                                            {% if transaction.category %}
                                                <div class="small text-muted">
                                                    <i data-feather="tag" class="me-1" style="width: 12px; height: 12px;"></i>
                                                    {{ transaction.category.name }}
                                                </div>
                                            {% endif %}
                                            
                                            {% if transaction.department %}
                                                <div class="small text-muted">
                                                    <i data-feather="users" class="me-1" style="width: 12px; height: 12px;"></i>
                                                    {{ transaction.department.name }}
                                                </div>
                                            {% endif %}
                                            
                                            {% if transaction.vendor %}
                                                <div class="small text-muted">
                                                    <i data-feather="briefcase" class="me-1" style="width: 12px; height: 12px;"></i>
                                                    {{ transaction.vendor.name }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" 
                                           class="btn btn-outline-primary" title="편집">
                                            <i data-feather="edit"></i>
                                        </a>
                                        <button class="btn btn-outline-secondary" 
                                                onclick="splitTransaction({{ transaction.id }})" 
                                                title="분할">
                                            <i data-feather="scissors"></i>
                                        </button>
                                        <button class="btn btn-outline-info" 
                                                onclick="viewDetails({{ transaction.id }})" 
                                                title="상세">
                                            <i data-feather="eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    조건에 맞는 거래 내역이 없습니다.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Grid View -->
<div id="grid-view" class="grid-container" style="display: none;">
    {% for transaction in transactions %}
    <div class="grid-item">
        <div class="card h-100 transaction-card">
            <div class="card-body">
                <!-- 체크박스와 거래처 정보 -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input transaction-checkbox" 
                               value="{{ transaction.id }}">
                    </div>
                    <div class="transaction-icon">
                        {% if transaction.amount > 0 %}
                            <i data-feather="arrow-down-right" class="text-success"></i>
                        {% else %}
                            <i data-feather="arrow-up-right" class="text-danger"></i>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 거래처 및 설명 -->
                <div class="mb-2">
                    <h6 class="card-title mb-1 text-truncate" style="font-size: 0.9rem;">{{ transaction.counterparty or '(거래처 미상)' }}</h6>
                    <p class="card-text text-muted mb-1" style="font-size: 0.75rem; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ transaction.description }}</p>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ transaction.account.institution.name }}</small>
                </div>
                
                <!-- 금액 -->
                <div class="mb-2 text-center">
                    <span class="h6 {{ transaction.amount | amount_color }}">
                        {{ transaction.amount | currency }}
                    </span>
                </div>
                
                <!-- 날짜 정보 -->
                <div class="mb-2 text-center">
                    <div class="fw-bold" style="font-size: 0.8rem;">{{ transaction.transaction_date.strftime('%m/%d') }}</div>
                    <small class="text-muted" style="font-size: 0.7rem;">{{ transaction.transaction_date.strftime('%H:%M') }}</small>
                </div>
                
                <!-- 분류 정보 -->
                <div class="mb-2 text-center">
                    <span class="badge badge-status-{{ transaction.classification_status }}" style="font-size: 0.65rem;">
                        {{ transaction.classification_status | classification_status }}
                    </span>
                </div>
                
                <!-- 작업 버튼 -->
                <div class="d-grid">
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" 
                           class="btn btn-outline-primary btn-sm" title="편집">
                            <i data-feather="edit" style="width: 12px; height: 12px;"></i>
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" 
                                onclick="splitTransaction({{ transaction.id }})" 
                                title="분할">
                            <i data-feather="scissors" style="width: 12px; height: 12px;"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" 
                                onclick="viewDetails({{ transaction.id }})" 
                                title="상세">
                            <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="text-center text-muted py-4">
            조건에 맞는 거래 내역이 없습니다.
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="거래 내역 페이지네이션">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('transactions', page=pagination.prev_num, **current_filters) }}">이전</a>
                    </li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transactions', page=page_num, **current_filters) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('transactions', page=pagination.next_num, **current_filters) }}">다음</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

<!-- Bulk Classify Modal -->
<div class="modal fade" id="bulkClassifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">일괄 분류</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="#">
                <div class="modal-body">
                    <p class="text-muted">선택된 <span id="bulkSelectedCount">0</span>개 거래를 일괄 분류합니다.</p>
                    
                    <div class="mb-3">
                        <label for="bulkCategory" class="form-label">카테고리</label>
                        <select class="form-select" id="bulkCategory" name="category_id">
                            <option value="">선택하세요</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulkDepartment" class="form-label">부서</label>
                        <select class="form-select" id="bulkDepartment" name="department_id">
                            <option value="">선택하세요</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">적용</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">거래 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailsContent">
                    <!-- 동적으로 로드 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 전체 선택 체크박스
    const selectAllCheckbox = document.getElementById('selectAll');
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    const bulkActionsDiv = document.querySelector('.bulk-actions');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    selectAllCheckbox.addEventListener('change', function() {
        transactionCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });
    
    transactionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCountSpan.textContent = count;
        
        if (count > 0) {
            bulkActionsDiv.style.display = 'block';
        } else {
            bulkActionsDiv.style.display = 'none';
        }
        
        // 전체 선택 체크박스 상태 업데이트
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === transactionCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
});

function bulkClassify() {
    const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
    const count = checkedBoxes.length;
    
    if (count === 0) {
        alert('분류할 거래를 선택해 주세요.');
        return;
    }
    
    document.getElementById('bulkSelectedCount').textContent = count;
    const modal = new bootstrap.Modal(document.getElementById('bulkClassifyModal'));
    modal.show();
}

function bulkExport() {
    const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        alert('내보낼 거래를 선택해 주세요.');
        return;
    }
    
    // 내보내기 로직
    const ids = Array.from(checkedBoxes).map(cb => cb.value);
    console.log('Exporting transactions:', ids);
}

// 보기 전환 함수
function switchView(view) {
    const listView = document.getElementById('list-view');
    const gridView = document.getElementById('grid-view');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (view === 'list') {
        listView.style.display = 'block';
        gridView.style.display = 'none';
        gridView.classList.remove('grid-container');
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
        
        // 로컬스토리지에 보기 설정 저장
        localStorage.setItem('transactionView', 'list');
    } else if (view === 'grid') {
        listView.style.display = 'none';
        gridView.style.display = 'grid';
        gridView.classList.add('grid-container');
        gridView.style.gridTemplateColumns = 'repeat(5, 1fr)';
        gridView.style.gap = '1rem';
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
        
        // 그리드 아이템들 강제 스타일 적용
        const gridItems = gridView.querySelectorAll('.grid-item');
        gridItems.forEach(item => {
            item.style.width = '100%';
            item.style.margin = '0';
            item.style.padding = '0';
        });
        
        // 로컬스토리지에 보기 설정 저장
        localStorage.setItem('transactionView', 'grid');
    }
    
    // Feather 아이콘 다시 렌더링
    feather.replace();
}

// 페이지 로드 시 저장된 보기 설정 적용
document.addEventListener('DOMContentLoaded', function() {
    const savedView = localStorage.getItem('transactionView') || 'list';
    switchView(savedView);
});

function splitTransaction(transactionId) {
    if (confirm('이 거래를 분할하시겠습니까?')) {
        // 거래 분할 로직
        console.log('Splitting transaction:', transactionId);
        alert('거래 분할 기능은 곧 추가될 예정입니다.');
    }
}

function viewDetails(transactionId) {
    // 거래 상세 정보 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
    
    // 상세 정보 로드 (실제로는 AJAX 호출)
    document.getElementById('transactionDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // 시뮬레이션된 상세 정보
    setTimeout(() => {
        document.getElementById('transactionDetailsContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>기본 정보</h6>
                    <table class="table table-sm">
                        <tr><td>거래 ID:</td><td>TXN-${transactionId}</td></tr>
                        <tr><td>거래일시:</td><td>2024-01-15 14:30:25</td></tr>
                        <tr><td>거래처:</td><td>스타벅스 강남점</td></tr>
                        <tr><td>금액:</td><td class="text-danger">-5,500원</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>분류 정보</h6>
                    <table class="table table-sm">
                        <tr><td>카테고리:</td><td>식비</td></tr>
                        <tr><td>부서:</td><td>개발팀</td></tr>
                        <tr><td>거래처:</td><td>스타벅스</td></tr>
                        <tr><td>분류상태:</td><td><span class="badge bg-success">자동분류</span></td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>원본 데이터</h6>
                    <pre class="bg-light p-3 small">{
  "transaction_id": "TXN-${transactionId}",
  "amount": -5500,
  "description": "스타벅스 강남점 체크카드",
  "merchant_category": "5814"
}</pre>
                </div>
            </div>
        `;
    }, 1000);
}
</script>
{% endblock %}
