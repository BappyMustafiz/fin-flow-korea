{% extends "base.html" %}
<!-- FORCED RELOAD -->

{% block title %}업체 관리 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block content %}
<div class="alert alert-info">
    <strong>템플릿 확인:</strong> 이 페이지는 base.html을 사용하고 있습니다 (수정됨)
    {% if debug_message %}<br><strong>라우트 확인:</strong> {{ debug_message }}{% endif %}
</div>
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i data-feather="briefcase" class="me-2"></i>업체 관리</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVendorModal">
                <i data-feather="plus" class="me-2"></i>새 업체 추가
            </button>
        </div>
    </div>
</div>

<!-- 업체 통계 카드 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">전체 업체</h5>
                        <h3 class="mb-0">{{ vendors|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i data-feather="briefcase" style="width: 2rem; height: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">분류 지정됨</h5>
                        <h3 class="mb-0">{{ vendors|selectattr('category')|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i data-feather="tag" style="width: 2rem; height: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">사업자번호 있음</h5>
                        <h3 class="mb-0">{{ vendors|selectattr('business_number')|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i data-feather="file-text" style="width: 2rem; height: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">연락처 있음</h5>
                        <h3 class="mb-0">{{ vendors|selectattr('contact_info')|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i data-feather="phone" style="width: 2rem; height: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 업체 목록 테이블 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">업체 목록</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>업체명</th>
                        <th>사업자번호</th>
                        <th>분류</th>
                        <th>연락처</th>
                        <th>등록일</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in vendors %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="vendor-icon me-2">
                                    <i data-feather="briefcase" class="text-primary"></i>
                                </div>
                                <strong>{{ vendor.name }}</strong>
                            </div>
                        </td>
                        <td>
                            {% if vendor.business_number %}
                                <code class="badge bg-secondary">{{ vendor.business_number }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if vendor.category %}
                                <span class="badge bg-info">{{ vendor.category.name }}</span>
                            {% else %}
                                <span class="text-muted">미분류</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if vendor.contact_info %}
                                <small class="text-muted">{{ vendor.contact_info[:30] }}{% if vendor.contact_info|length > 30 %}...{% endif %}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ vendor.created_at.strftime('%Y-%m-%d') if vendor.created_at else '-' }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <!-- 편집 버튼 -->
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        title="편집"
                                        onclick="editVendor({{ vendor.id }}, '{{ vendor.name }}', '{{ vendor.business_number or '' }}', '{{ vendor.contact_info or '' }}', {{ vendor.category_id or 'null' }})">
                                    <i data-feather="edit"></i>
                                </button>
                                
                                <!-- 삭제 버튼 -->
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        title="삭제"
                                        onclick="deleteVendor({{ vendor.id }}, '{{ vendor.name }}')">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            등록된 업체가 없습니다.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 업체 추가 모달 -->
<div class="modal fade" id="addVendorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 업체 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_vendor') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="vendorName" class="form-label">업체명 *</label>
                        <input type="text" class="form-control" id="vendorName" name="name" required
                               placeholder="업체명을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label for="vendorBusinessNumber" class="form-label">사업자번호</label>
                        <input type="text" class="form-control" id="vendorBusinessNumber" name="business_number"
                               placeholder="000-00-00000 형식으로 입력">
                    </div>
                    <div class="mb-3">
                        <label for="vendorCategory" class="form-label">분류</label>
                        <select class="form-select" id="vendorCategory" name="category_id">
                            <option value="">분류 선택</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vendorContact" class="form-label">연락처</label>
                        <textarea class="form-control" id="vendorContact" name="contact_info" rows="3"
                                  placeholder="전화번호, 이메일, 주소 등 연락처 정보를 입력하세요"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="plus" class="me-1"></i>업체 추가
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 업체 편집 모달 -->
<div class="modal fade" id="editVendorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">업체 편집</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editVendorName" class="form-label">업체명 *</label>
                        <input type="text" class="form-control" id="editVendorName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVendorBusinessNumber" class="form-label">사업자번호</label>
                        <input type="text" class="form-control" id="editVendorBusinessNumber" name="business_number">
                    </div>
                    <div class="mb-3">
                        <label for="editVendorCategory" class="form-label">분류</label>
                        <select class="form-select" id="editVendorCategory" name="category_id">
                            <option value="">분류 선택</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editVendorContact" class="form-label">연락처</label>
                        <textarea class="form-control" id="editVendorContact" name="contact_info" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save" class="me-1"></i>변경사항 저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 삭제 확인 폼 (숨김) -->
<form method="POST" id="deleteForm" style="display: none;">
</form>

<style>
.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.table-responsive {
    border-radius: 0.375rem;
}

.badge {
    font-size: 0.75rem;
}

.modal-body .form-label {
    font-weight: 600;
    color: #495057;
}

.vendor-icon i {
    width: 20px;
    height: 20px;
}

code.badge {
    font-family: 'Courier New', monospace;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// 업체 편집 함수
function editVendor(id, name, businessNumber, contactInfo, categoryId) {
    document.getElementById('editForm').action = '/vendors/' + id + '/edit';
    document.getElementById('editVendorName').value = name;
    document.getElementById('editVendorBusinessNumber').value = businessNumber;
    document.getElementById('editVendorContact').value = contactInfo;
    
    // 분류 선택
    const categorySelect = document.getElementById('editVendorCategory');
    categorySelect.value = categoryId || '';
    
    const modal = new bootstrap.Modal(document.getElementById('editVendorModal'));
    modal.show();
}

// 업체 삭제 함수
function deleteVendor(id, name) {
    if (confirm('업체 "' + name + '"을(를) 삭제하시겠습니까?\n\n주의: 이 업체와 연결된 계약이나 거래가 있으면 삭제할 수 없습니다.')) {
        document.getElementById('deleteForm').action = '/vendors/' + id + '/delete';
        document.getElementById('deleteForm').submit();
    }
}

// 모달이 열릴 때 feather 아이콘 다시 렌더링
document.addEventListener('DOMContentLoaded', function() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            feather.replace();
        });
    });
});
</script>
{% endblock %}<!-- Cache bust: Mon Sep  8 06:46:06 PM UTC 2025 -->
