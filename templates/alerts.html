{% extends "layout.html" %}

{% block title %}알림/설정 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">알림 및 설정</h1>
        <p class="text-muted">시스템 알림, 임계값 설정 및 보안 관리</p>
    </div>
</div>

<!-- Alert Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center alert-summary-card">
            <div class="card-body">
                <i data-feather="bell" class="text-danger mb-2" style="width: 48px; height: 48px;"></i>
                <h4 class="text-danger">{{ alerts | selectattr('is_read', 'equalto', False) | list | length }}</h4>
                <p class="text-muted mb-0">읽지 않은 알림</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center alert-summary-card">
            <div class="card-body">
                <i data-feather="dollar-sign" class="text-warning mb-2" style="width: 48px; height: 48px;"></i>
                <h4 class="text-warning">{{ alerts | selectattr('alert_type', 'equalto', 'budget') | list | length }}</h4>
                <p class="text-muted mb-0">예산 알림</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center alert-summary-card">
            <div class="card-body">
                <i data-feather="file-text" class="text-info mb-2" style="width: 48px; height: 48px;"></i>
                <h4 class="text-info">{{ alerts | selectattr('alert_type', 'equalto', 'contract') | list | length }}</h4>
                <p class="text-muted mb-0">계약 알림</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center alert-summary-card">
            <div class="card-body">
                <i data-feather="alert-triangle" class="text-danger mb-2" style="width: 48px; height: 48px;"></i>
                <h4 class="text-danger">{{ alerts | selectattr('alert_type', 'equalto', 'anomaly') | list | length }}</h4>
                <p class="text-muted mb-0">이상거래 알림</p>
            </div>
        </div>
    </div>
</div>

<!-- Alert Settings -->
<div class="row mb-4">
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i data-feather="settings" class="me-2"></i>
                    알림 설정
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#alertSettingsModal">
                    <i data-feather="plus" class="me-1"></i>설정 추가
                </button>
            </div>
            <div class="card-body">
                <div class="alert-settings">
                    <!-- Budget Alert Settings -->
                    <div class="setting-section mb-4 p-3 border rounded">
                        <div class="row align-items-end">
                            <div class="col-md-2">
                                <h6 class="mb-2 text-primary">
                                    <i data-feather="dollar-sign" class="me-2"></i>
                                    예산 알림
                                </h6>
                                <button class="btn btn-primary btn-sm" onclick="createBudgetAlert()">
                                    <i data-feather="check" class="me-1"></i>확인
                                </button>
                            </div>
                            <div class="col-md-3">
                                <label for="budgetThreshold" class="form-label small">임계치 (%)</label>
                                <input type="number" class="form-control form-control-sm" id="budgetThreshold" 
                                       value="80" min="50" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="budgetFrequency" class="form-label small">알림 주기</label>
                                <select class="form-select form-select-sm" id="budgetFrequency">
                                    <option value="daily">매일</option>
                                    <option value="weekly" selected>매주</option>
                                    <option value="monthly">매월</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="budgetSeverity" class="form-label small">중요도</label>
                                <select class="form-select form-select-sm" id="budgetSeverity">
                                    <option value="info">정보</option>
                                    <option value="warning" selected>경고</option>
                                    <option value="critical">위험</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="budgetChannel" class="form-label small">알림 방식</label>
                                <select class="form-select form-select-sm" id="budgetChannel">
                                    <option value="app" selected>앱</option>
                                    <option value="email">이메일</option>
                                    <option value="sms">SMS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contract Alert Settings -->
                    <div class="setting-section mb-4 p-3 border rounded">
                        <div class="row align-items-end">
                            <div class="col-md-2">
                                <h6 class="mb-2 text-info">
                                    <i data-feather="file-text" class="me-2"></i>
                                    계약 만료 알림
                                </h6>
                                <button class="btn btn-primary btn-sm" onclick="createContractAlert()">
                                    <i data-feather="check" class="me-1"></i>확인
                                </button>
                            </div>
                            <div class="col-md-3">
                                <label for="contractDays" class="form-label small">사전 알림 (일)</label>
                                <input type="number" class="form-control form-control-sm" id="contractDays" 
                                       value="30" min="7" max="90">
                            </div>
                            <div class="col-md-3">
                                <label for="contractFrequency" class="form-label small">알림 주기</label>
                                <select class="form-select form-select-sm" id="contractFrequency">
                                    <option value="daily" selected>매일</option>
                                    <option value="weekly">매주</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="contractSeverity" class="form-label small">중요도</label>
                                <select class="form-select form-select-sm" id="contractSeverity">
                                    <option value="info">정보</option>
                                    <option value="warning" selected>경고</option>
                                    <option value="critical">위험</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="contractChannel" class="form-label small">알림 방식</label>
                                <select class="form-select form-select-sm" id="contractChannel">
                                    <option value="app" selected>앱</option>
                                    <option value="email">이메일</option>
                                    <option value="sms">SMS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Anomaly Alert Settings -->
                    <div class="setting-section mb-4 p-3 border rounded">
                        <div class="row align-items-end">
                            <div class="col-md-2">
                                <h6 class="mb-2 text-danger">
                                    <i data-feather="alert-triangle" class="me-2"></i>
                                    이상거래 알림
                                </h6>
                                <button class="btn btn-primary btn-sm" onclick="createAnomalyAlert()">
                                    <i data-feather="check" class="me-1"></i>확인
                                </button>
                            </div>
                            <div class="col-md-3">
                                <label for="anomalyAmount" class="form-label small">이상 금액 (원)</label>
                                <input type="text" class="form-control form-control-sm" id="anomalyAmount" 
                                       value="1,000,000" placeholder="예: 1,000,000">
                            </div>
                            <div class="col-md-3">
                                <label for="anomalySeverity" class="form-label small">중요도</label>
                                <select class="form-select form-select-sm" id="anomalySeverity">
                                    <option value="info">정보</option>
                                    <option value="warning">경고</option>
                                    <option value="critical" selected>위험</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="anomalyChannel" class="form-label small">알림 방식</label>
                                <select class="form-select form-select-sm" id="anomalyChannel">
                                    <option value="app" selected>앱</option>
                                    <option value="email">이메일</option>
                                    <option value="sms">SMS</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="immediateAlert">
                                    <label class="form-check-label small" for="immediateAlert">
                                        즉시 알림
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Alert Settings Section -->
                    <div class="setting-section mb-4">
                        <h6 class="text-primary">
                            <i data-feather="bell" class="me-2"></i>
                            사용자 정의 알림 설정
                        </h6>
                        
                        <!-- 거래처 텍스트 포함 알림 -->
                        <div class="setting-section mb-3 p-3 border rounded">
                            <div class="row align-items-end">
                                <div class="col-md-2">
                                    <h6 class="mb-2 text-primary">거래처 포함 알림</h6>
                                    <button class="btn btn-primary btn-sm" onclick="createCounterpartyAlert()">
                                        <i data-feather="check" class="me-1"></i>확인
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <label for="counterpartyKeyword" class="form-label small">포함 키워드</label>
                                    <input type="text" class="form-control form-control-sm" id="counterpartyKeyword" 
                                           placeholder="예: 스타벅스, KB은행">
                                </div>
                                <div class="col-md-3">
                                    <label for="counterpartySeverity" class="form-label small">중요도</label>
                                    <select class="form-select form-select-sm" id="counterpartySeverity">
                                        <option value="info">정보</option>
                                        <option value="warning" selected>경고</option>
                                        <option value="critical">위험</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="counterpartyChannel" class="form-label small">알림 방식</label>
                                    <select class="form-select form-select-sm" id="counterpartyChannel">
                                        <option value="app" selected>앱</option>
                                        <option value="email">이메일</option>
                                        <option value="sms">SMS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 거래내용 정확히 일치 알림 -->
                        <div class="setting-section mb-3 p-3 border rounded">
                            <div class="row align-items-end">
                                <div class="col-md-2">
                                    <h6 class="mb-2 text-primary">거래내용 일치 알림</h6>
                                    <button class="btn btn-primary btn-sm" onclick="createDescriptionAlert()">
                                        <i data-feather="check" class="me-1"></i>확인
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <label for="descriptionKeyword" class="form-label small">정확한 내용</label>
                                    <input type="text" class="form-control form-control-sm" id="descriptionKeyword" 
                                           placeholder="예: 급여, 임대료">
                                </div>
                                <div class="col-md-3">
                                    <label for="descriptionSeverity" class="form-label small">중요도</label>
                                    <select class="form-select form-select-sm" id="descriptionSeverity">
                                        <option value="info" selected>정보</option>
                                        <option value="warning">경고</option>
                                        <option value="critical">위험</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="descriptionChannel" class="form-label small">알림 방식</label>
                                    <select class="form-select form-select-sm" id="descriptionChannel">
                                        <option value="app" selected>앱</option>
                                        <option value="email">이메일</option>
                                        <option value="sms">SMS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 금액 범위 알림 -->
                        <div class="setting-section mb-3 p-3 border rounded">
                            <div class="row align-items-end">
                                <div class="col-md-2">
                                    <h6 class="mb-2 text-primary">금액 범위 알림</h6>
                                    <button class="btn btn-primary btn-sm" onclick="createAmountAlert()">
                                        <i data-feather="check" class="me-1"></i>확인
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <label for="amountCondition" class="form-label small">조건</label>
                                    <select class="form-select form-select-sm" id="amountCondition">
                                        <option value="greater">초과</option>
                                        <option value="less">미만</option>
                                        <option value="between">사이</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="amountValue1" class="form-label small">금액 (원)</label>
                                    <input type="text" class="form-control form-control-sm" id="amountValue1" 
                                           placeholder="1,000,000">
                                </div>
                                <div class="col-md-2">
                                    <label for="amountValue2" class="form-label small">~최대 (원)</label>
                                    <input type="text" class="form-control form-control-sm" id="amountValue2" 
                                           placeholder="5,000,000" style="display: none;">
                                </div>
                                <div class="col-md-2">
                                    <label for="amountSeverity" class="form-label small">중요도</label>
                                    <select class="form-select form-select-sm" id="amountSeverity">
                                        <option value="info">정보</option>
                                        <option value="warning" selected>경고</option>
                                        <option value="critical">위험</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 고급 패턴 알림 -->
                        <div class="setting-section mb-3 p-3 border rounded">
                            <div class="row align-items-end">
                                <div class="col-md-2">
                                    <h6 class="mb-2 text-primary">고급 패턴 알림</h6>
                                    <button class="btn btn-primary btn-sm" onclick="createAdvancedAlert()">
                                        <i data-feather="check" class="me-1"></i>확인
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <label for="advancedPattern" class="form-label small">정규식 패턴</label>
                                    <input type="text" class="form-control form-control-sm" id="advancedPattern" 
                                           placeholder="예: ^KB.*은행$, .*카드.*">
                                </div>
                                <div class="col-md-2">
                                    <label for="advancedField" class="form-label small">적용 필드</label>
                                    <select class="form-select form-select-sm" id="advancedField">
                                        <option value="counterparty" selected>거래처</option>
                                        <option value="description">거래내용</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="advancedSeverity" class="form-label small">중요도</label>
                                    <select class="form-select form-select-sm" id="advancedSeverity">
                                        <option value="info">정보</option>
                                        <option value="warning">경고</option>
                                        <option value="critical" selected>위험</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="advancedChannel" class="form-label small">알림</label>
                                    <select class="form-select form-select-sm" id="advancedChannel">
                                        <option value="app" selected>앱</option>
                                        <option value="email">이메일</option>
                                        <option value="sms">SMS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 생성된 알림 카드 표시 영역 -->
                        <div class="mt-4">
                            <h6 class="text-secondary mb-3">
                                <i data-feather="layers" class="me-2"></i>
                                생성된 사용자 정의 알림
                            </h6>
                            <div id="customAlertCards" class="row">
                                <!-- 기존 알림 카드들 표시 -->
                                {% if alert_settings %}
                                    {% for setting in alert_settings %}
                                    {% if setting.alert_type == 'custom' %}
                                    <div class="col-md-6 mb-3" id="alertCard_{{ setting.id }}">
                                        <div class="card border {% if not setting.is_active %}bg-light{% endif %}">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-1">{{ setting.name }}</h6>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               {% if setting.is_active %}checked{% endif %}
                                                               onchange="toggleAlertSetting({{ setting.id }})">
                                                    </div>
                                                </div>
                                                <p class="card-text text-muted small mb-2">{{ setting.condition }}</p>
                                                <div class="mb-2">
                                                    <span class="badge bg-{{ 'info' if setting.severity == 'info' else 'warning' if setting.severity == 'warning' else 'danger' }} me-1">
                                                        {{ setting.severity.title() }}
                                                    </span>
                                                    <span class="badge bg-secondary">
                                                        {{ setting.channel.title() }}
                                                    </span>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-danger" onclick="deleteAlertSetting({{ setting.id }})" title="삭제">
                                                        <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 빠른 작업 버튼들 -->
                        <div class="mt-3">
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <button class="btn btn-outline-secondary btn-sm" onclick="markAllAsRead()">
                                    <i data-feather="check" class="me-1"></i>모든 알림 읽음
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="exportAlerts()">
                                    <i data-feather="download" class="me-1"></i>알림 내역 내보내기
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearOldAlerts()">
                                    <i data-feather="trash-2" class="me-1"></i>오래된 알림 정리
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button class="btn btn-success" onclick="saveAlertSettings()">
                        <i data-feather="save" class="me-1"></i>설정 저장
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 생성된 알림 카드 사이드바 -->
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="layers" class="me-2"></i>
                    생성된 알림
                </h5>
            </div>
            <div class="card-body p-0" style="max-height: 800px; overflow-y: auto;">
                
                <!-- 시스템 알림 섹션 -->
                <div class="p-3 border-bottom">
                    <h6 class="text-primary mb-3">
                        <i data-feather="settings" class="me-2"></i>
                        시스템 알림
                    </h6>
                    <div id="systemAlertCards" class="alert-cards-list">
                        <!-- 기존 시스템 알림 카드들 표시 -->
                        {% if alert_settings %}
                            {% for setting in alert_settings %}
                            {% if setting.alert_type in ['budget', 'contract', 'anomaly'] %}
                            <div class="alert-card-item mb-3" id="alertCard_{{ setting.id }}">
                                <div class="card border-start border-4 border-primary {% if not setting.is_active %}bg-light{% endif %}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-1 small">{{ setting.name }}</h6>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input form-check-input-sm" type="checkbox" 
                                                       {% if setting.is_active %}checked{% endif %}
                                                       onchange="toggleAlertSetting({{ setting.id }})">
                                            </div>
                                        </div>
                                        <p class="card-text text-muted small mb-2">{{ setting.condition }}</p>
                                        <div class="mb-2">
                                            <span class="badge badge-sm bg-{{ 'info' if setting.severity == 'info' else 'warning' if setting.severity == 'warning' else 'danger' }} me-1">
                                                {{ setting.severity.title() }}
                                            </span>
                                            <span class="badge badge-sm bg-secondary me-1">
                                                {{ setting.channel.title() }}
                                            </span>
                                            <span class="badge badge-sm bg-primary">
                                                {% if setting.alert_type == 'budget' %}예산{% elif setting.alert_type == 'contract' %}계약{% elif setting.alert_type == 'anomaly' %}이상거래{% endif %}
                                            </span>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAlertSetting({{ setting.id }})" title="삭제">
                                            <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                                            삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- 사용자 정의 알림 섹션 -->
                <div class="p-3">
                    <h6 class="text-success mb-3">
                        <i data-feather="user" class="me-2"></i>
                        사용자 정의 알림
                    </h6>
                    <div id="customAlertCards" class="alert-cards-list">
                        <!-- 기존 사용자 정의 알림 카드들 표시 -->
                        {% if alert_settings %}
                            {% for setting in alert_settings %}
                            {% if setting.alert_type == 'custom' %}
                            <div class="alert-card-item mb-3" id="alertCard_{{ setting.id }}">
                                <div class="card border-start border-4 border-success {% if not setting.is_active %}bg-light{% endif %}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-1 small">{{ setting.name }}</h6>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input form-check-input-sm" type="checkbox" 
                                                       {% if setting.is_active %}checked{% endif %}
                                                       onchange="toggleAlertSetting({{ setting.id }})">
                                            </div>
                                        </div>
                                        <p class="card-text text-muted small mb-2">{{ setting.condition }}</p>
                                        <div class="mb-2">
                                            <span class="badge badge-sm bg-{{ 'info' if setting.severity == 'info' else 'warning' if setting.severity == 'warning' else 'danger' }} me-1">
                                                {{ setting.severity.title() }}
                                            </span>
                                            <span class="badge badge-sm bg-secondary">
                                                {{ setting.channel.title() }}
                                            </span>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAlertSetting({{ setting.id }})" title="삭제">
                                            <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                                            삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>

<!-- Alert List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i data-feather="list" class="me-2"></i>
                    알림 목록
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" onclick="filterAlerts('all')">전체</button>
                    <button class="btn btn-outline-secondary" onclick="filterAlerts('unread')">읽지않음</button>
                    <button class="btn btn-outline-secondary" onclick="filterAlerts('budget')">예산</button>
                    <button class="btn btn-outline-secondary" onclick="filterAlerts('contract')">계약</button>
                    <button class="btn btn-outline-secondary" onclick="filterAlerts('anomaly')">이상거래</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="alert-list">
                    {% for alert in alerts %}
                    <div class="alert-item {{ 'unread' if not alert.is_read else '' }}" data-alert-type="{{ alert.alert_type }}">
                        <div class="d-flex">
                            <div class="alert-icon me-3">
                                {% if alert.alert_type == 'budget' %}
                                    <i data-feather="dollar-sign" class="text-warning"></i>
                                {% elif alert.alert_type == 'contract' %}
                                    <i data-feather="file-text" class="text-info"></i>
                                {% elif alert.alert_type == 'anomaly' %}
                                    <i data-feather="alert-triangle" class="text-danger"></i>
                                {% else %}
                                    <i data-feather="bell" class="text-primary"></i>
                                {% endif %}
                            </div>
                            
                            <div class="alert-content flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="alert-title mb-0">{{ alert.title }}</h6>
                                    <div class="alert-actions">
                                        <small class="text-muted me-3">{{ alert.created_at.strftime('%m/%d %H:%M') }}</small>
                                        {% if not alert.is_read %}
                                            <a href="{{ url_for('mark_alert_read', alert_id=alert.id) }}" 
                                               class="btn btn-sm btn-outline-primary">읽음</a>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <p class="alert-message text-muted mb-2">{{ alert.message }}</p>
                                
                                <div class="alert-meta">
                                    <span class="badge badge-alert-{{ alert.alert_type }}">
                                        {{ alert.alert_type | alert_type }}
                                    </span>
                                    <span class="badge {% if alert.severity == 'error' %}bg-danger{% elif alert.severity == 'warning' %}bg-warning{% else %}bg-info{% endif %}">
                                        {{ alert.severity.title() }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i data-feather="check-circle" class="mb-3" style="width: 64px; height: 64px;"></i>
                        <h5>알림이 없습니다</h5>
                        <p>새로운 알림이 있으면 여기에 표시됩니다.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Settings Modal -->
<div class="modal fade" id="alertSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 알림 설정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_alert_setting') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newAlertType" class="form-label">알림 유형</label>
                        <select class="form-select" id="newAlertType" name="alert_type" required>
                            <option value="">선택하세요</option>
                            <option value="budget">예산 초과</option>
                            <option value="contract">계약 만료</option>
                            <option value="anomaly">이상거래</option>
                            <option value="custom">사용자 정의</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alertName" class="form-label">알림명</label>
                        <input type="text" class="form-control" id="alertName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alertCondition" class="form-label">조건</label>
                        <textarea class="form-control" id="alertCondition" name="condition" rows="3" 
                                  placeholder="예시:&#10;counterparty contains 스타벅스&#10;amount > 500000&#10;description equals 급여"></textarea>
                        <small class="form-text text-muted">
                            <strong>사용 가능한 조건:</strong><br>
                            • counterparty contains 텍스트 (거래처에 텍스트 포함)<br>
                            • description equals 정확한텍스트 (거래내용 정확히 일치)<br>
                            • amount > 금액 또는 amount < 금액 (금액 크거나 작은 경우)<br>
                            • counterparty regex 정규표현식 (고급 패턴)
                        </small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="alertSeverity" class="form-label">심각도</label>
                                <select class="form-select" id="alertSeverity" name="severity">
                                    <option value="info">정보</option>
                                    <option value="warning" selected>경고</option>
                                    <option value="error">오류</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="alertChannel" class="form-label">알림 채널</label>
                                <select class="form-select" id="alertChannel" name="channel">
                                    <option value="system">시스템 알림</option>
                                    <option value="email">이메일</option>
                                    <option value="sms">SMS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Alert Setting Modal -->
<div class="modal fade" id="editAlertModal" tabindex="-1" aria-labelledby="editAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAlertModalLabel">
                    <i data-feather="edit-2" class="me-2"></i>
                    알림 설정 수정
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/alerts/settings/edit" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="setting_id" id="editSettingId">
                    
                    <div class="mb-3">
                        <label for="editAlertName" class="form-label">알림 이름 *</label>
                        <input type="text" class="form-control" id="editAlertName" name="name" required 
                               placeholder="예: 스타벅스 결제 알림">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editConditionType" class="form-label">조건 유형 *</label>
                        <select class="form-select" id="editConditionType" name="condition_type" required onchange="updateEditConditionInput()">
                            <option value="">조건 유형을 선택하세요</option>
                            <option value="counterparty_contains">거래처 포함</option>
                            <option value="counterparty_equals">거래처 일치</option>
                            <option value="description_contains">거래내용 포함</option>
                            <option value="description_equals">거래내용 일치</option>
                            <option value="amount_greater">금액 초과</option>
                            <option value="amount_less">금액 미만</option>
                            <option value="custom">직접 입력</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editConditionValue" class="form-label">조건 값 *</label>
                        <input type="text" class="form-control" id="editConditionValue" name="condition_value" required 
                               placeholder="조건에 맞는 값을 입력하세요">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCondition" class="form-label">완성된 조건</label>
                        <input type="text" class="form-control" id="editCondition" name="condition" readonly 
                               placeholder="위 설정에 따라 자동으로 생성됩니다">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editSeverity" class="form-label">중요도</label>
                            <select class="form-select" id="editSeverity" name="severity">
                                <option value="info">정보</option>
                                <option value="warning">경고</option>
                                <option value="critical">위험</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editChannel" class="form-label">알림 방식</label>
                            <select class="form-select" id="editChannel" name="channel">
                                <option value="app">앱 내 알림</option>
                                <option value="email">이메일</option>
                                <option value="sms">SMS</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>조건 작성 예시:</strong><br>
                            • counterparty contains 스타벅스<br>
                            • amount > 500000<br>
                            • description equals 급여<br>
                            • counterparty regex ^KB.*은행$
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save" class="me-1"></i>수정 완료
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterAlerts(type) {
    const alertItems = document.querySelectorAll('.alert-item');
    const filterButtons = document.querySelectorAll('.btn-group .btn');
    
    // 버튼 상태 업데이트
    filterButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    alertItems.forEach(item => {
        if (type === 'all') {
            item.style.display = 'block';
        } else if (type === 'unread') {
            item.style.display = item.classList.contains('unread') ? 'block' : 'none';
        } else {
            item.style.display = item.dataset.alertType === type ? 'block' : 'none';
        }
    });
}

function markAllAsRead() {
    if (confirm('모든 알림을 읽음 처리하시겠습니까?')) {
        // 실제로는 서버 요청
        document.querySelectorAll('.alert-item.unread').forEach(item => {
            item.classList.remove('unread');
            const button = item.querySelector('.btn-outline-primary');
            if (button) button.remove();
        });
        
        showToast('모든 알림이 읽음 처리되었습니다.', 'success');
    }
}

function testAlerts() {
    showToast('알림 테스트를 실행합니다...', 'info');
    
    // 테스트 알림 시뮬레이션
    setTimeout(() => {
        showToast('테스트 알림이 발송되었습니다. 설정된 채널을 확인해 주세요.', 'success');
    }, 2000);
}

function exportAlerts() {
    // 내보내기 형식 선택 모달 생성
    const modalHTML = `
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">알림 내역 내보내기</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">내보내기 형식</label>
                            <select class="form-select" id="exportFormat">
                                <option value="csv">CSV 파일</option>
                                <option value="excel">Excel 파일</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">기간 설정</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="date" class="form-control" id="startDate" placeholder="시작일">
                                </div>
                                <div class="col-md-6">
                                    <input type="date" class="form-control" id="endDate" placeholder="종료일">
                                </div>
                            </div>
                            <small class="text-muted">기간을 설정하지 않으면 최근 6개월 데이터를 내보냅니다.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">알림 유형</label>
                            <select class="form-select" id="alertTypeFilter">
                                <option value="all">전체 알림</option>
                                <option value="budget">예산 알림</option>
                                <option value="contract">계약 알림</option>
                                <option value="anomaly">이상거래 알림</option>
                                <option value="custom">사용자 정의 알림</option>
                                <option value="system">시스템 알림</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" onclick="doExportAlerts()">
                            <i data-feather="download" class="me-1"></i>내보내기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 기존 모달 제거 후 새로 추가
    const existingModal = document.getElementById('exportModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
    
    // 아이콘 렌더링
    feather.replace();
}

function doExportAlerts() {
    const format = document.getElementById('exportFormat').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const alertType = document.getElementById('alertTypeFilter').value;
    
    // URL 생성
    const params = new URLSearchParams({
        format: format,
        alert_type: alertType
    });
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    const url = `/alerts/export?${params.toString()}`;
    
    // 모달 닫기
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    
    // 로딩 메시지 표시
    showToast('알림 내역을 내보내고 있습니다...', 'info');
    
    // 파일 다운로드
    const link = document.createElement('a');
    link.href = url;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // 완료 메시지
    setTimeout(() => {
        showToast('알림 내역 파일이 다운로드되었습니다.', 'success');
    }, 1000);
}

function clearOldAlerts() {
    if (confirm('30일 이전의 읽은 알림을 모두 삭제하시겠습니까?')) {
        showToast('오래된 알림을 정리하고 있습니다...', 'info');
        
        setTimeout(() => {
            showToast('15개의 오래된 알림이 삭제되었습니다.', 'success');
        }, 2000);
    }
}

// 천단위 콤마 포맷팅
function formatNumberWithCommas(value) {
    // 숫자가 아닌 문자 제거
    const numbers = value.replace(/[^0-9]/g, '');
    // 천단위 콤마 추가
    return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// 페이지 로드 시 설정값 로드 및 이벤트 리스너 추가
document.addEventListener('DOMContentLoaded', function() {
    // 서버에서 전달된 현재 설정값 로드
    try {
        {% if current_settings %}
        const currentSettings = {{ current_settings | tojson | safe }};
        if (currentSettings && typeof currentSettings === 'object') {
            loadCurrentSettings(currentSettings);
        }
        {% endif %}
    } catch (e) {
        console.error('Settings load error:', e);
    }
    
    const anomalyAmountField = document.getElementById('anomalyAmount');
    
    if (anomalyAmountField) {
        // 입력 시 실시간 콤마 포맷팅
        anomalyAmountField.addEventListener('input', function(e) {
            const cursorPosition = e.target.selectionStart;
            const oldValue = e.target.value;
            const newValue = formatNumberWithCommas(oldValue);
            
            e.target.value = newValue;
            
            // 커서 위치 조정 (콤마 추가로 인한 위치 변경 보정)
            const commaChange = newValue.length - oldValue.length;
            e.target.setSelectionRange(cursorPosition + commaChange, cursorPosition + commaChange);
        });
        
        // 포커스 시 모든 텍스트 선택
        anomalyAmountField.addEventListener('focus', function(e) {
            e.target.select();
        });
    }
    
    // 사용자 정의 알림 설정 이벤트 리스너 추가
    setupCustomAlertSettings();
});

// 현재 설정값을 폼에 로드하는 함수
function loadCurrentSettings(settings) {
    // 예산 알림
    if (settings.budgetAlert !== undefined) {
        document.getElementById('budgetAlertEnabled').checked = settings.budgetAlert;
    }
    if (settings.budgetThreshold) {
        document.getElementById('budgetThreshold').value = settings.budgetThreshold;
    }
    if (settings.budgetFrequency) {
        document.getElementById('budgetFrequency').value = settings.budgetFrequency;
    }
    
    // 계약 알림
    if (settings.contractAlert !== undefined) {
        document.getElementById('contractAlertEnabled').checked = settings.contractAlert;
    }
    if (settings.contractDays) {
        document.getElementById('contractDays').value = settings.contractDays;
    }
    if (settings.contractFrequency) {
        document.getElementById('contractFrequency').value = settings.contractFrequency;
    }
    
    // 이상거래 알림
    if (settings.anomalyAlert !== undefined) {
        document.getElementById('anomalyAlertEnabled').checked = settings.anomalyAlert;
    }
    if (settings.anomalyAmount) {
        // 천단위 콤마 포맷팅 적용
        const formattedAmount = formatNumberWithCommas(settings.anomalyAmount);
        document.getElementById('anomalyAmount').value = formattedAmount;
    }
    if (settings.immediateAlert !== undefined) {
        document.getElementById('immediateAlert').checked = settings.immediateAlert;
    }
    
    // 사용자 정의 알림 설정 로드
    if (settings.customAlerts) {
        const custom = settings.customAlerts;
        
        // 거래처 포함 알림
        if (custom.counterparty) {
            document.getElementById('counterpartyAlertEnabled').checked = custom.counterparty.enabled || false;
            document.getElementById('counterpartyKeyword').value = custom.counterparty.keyword || '';
            document.getElementById('counterpartySeverity').value = custom.counterparty.severity || 'warning';
            document.getElementById('counterpartyChannel').value = custom.counterparty.channel || 'app';
        }
        
        // 거래내용 일치 알림
        if (custom.description) {
            document.getElementById('descriptionAlertEnabled').checked = custom.description.enabled || false;
            document.getElementById('descriptionKeyword').value = custom.description.keyword || '';
            document.getElementById('descriptionSeverity').value = custom.description.severity || 'info';
            document.getElementById('descriptionChannel').value = custom.description.channel || 'app';
        }
        
        // 금액 범위 알림
        if (custom.amount) {
            document.getElementById('amountAlertEnabled').checked = custom.amount.enabled || false;
            document.getElementById('amountCondition').value = custom.amount.condition || 'greater';
            document.getElementById('amountValue1').value = formatNumberWithCommas(custom.amount.value1 || '');
            document.getElementById('amountValue2').value = formatNumberWithCommas(custom.amount.value2 || '');
            document.getElementById('amountSeverity').value = custom.amount.severity || 'warning';
            document.getElementById('amountChannel').value = custom.amount.channel || 'app';
            
            // 조건에 따라 두 번째 필드 표시
            const amountValue2Field = document.getElementById('amountValue2');
            if (custom.amount.condition === 'between') {
                amountValue2Field.style.display = 'block';
                amountValue2Field.parentElement.style.display = 'block';
            }
        }
        
        // 고급 패턴 알림
        if (custom.advanced) {
            document.getElementById('advancedAlertEnabled').checked = custom.advanced.enabled || false;
            document.getElementById('advancedPattern').value = custom.advanced.pattern || '';
            document.getElementById('advancedField').value = custom.advanced.field || 'counterparty';
            document.getElementById('advancedSeverity').value = custom.advanced.severity || 'critical';
            document.getElementById('advancedChannel').value = custom.advanced.channel || 'app';
        }
    }
}

// 사용자 정의 알림 설정 초기화
function setupCustomAlertSettings() {
    // 금액 필드에 콤마 포맷팅 적용
    const amountFields = ['amountValue1', 'amountValue2'];
    amountFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function(e) {
                const cursorPosition = e.target.selectionStart;
                const oldValue = e.target.value;
                const newValue = formatNumberWithCommas(oldValue);
                
                e.target.value = newValue;
                
                const commaChange = newValue.length - oldValue.length;
                e.target.setSelectionRange(cursorPosition + commaChange, cursorPosition + commaChange);
            });
            
            field.addEventListener('focus', function(e) {
                e.target.select();
            });
        }
    });
    
    // 금액 조건 변경 시 두 번째 입력 필드 표시/숨김
    const amountCondition = document.getElementById('amountCondition');
    const amountValue2 = document.getElementById('amountValue2');
    
    if (amountCondition && amountValue2) {
        amountCondition.addEventListener('change', function() {
            if (this.value === 'between') {
                amountValue2.style.display = 'block';
                amountValue2.parentElement.style.display = 'block';
            } else {
                amountValue2.style.display = 'none';
                amountValue2.parentElement.style.display = 'none';
            }
        });
    }
}

function saveAlertSettings() {
    // 이상 금액에서 콤마 제거하고 숫자로 변환
    const anomalyAmountValue = document.getElementById('anomalyAmount').value.replace(/,/g, '');
    
    const settings = {
        budgetAlert: document.getElementById('budgetAlertEnabled').checked,
        budgetThreshold: document.getElementById('budgetThreshold').value,
        budgetFrequency: document.getElementById('budgetFrequency').value,
        contractAlert: document.getElementById('contractAlertEnabled').checked,
        contractDays: document.getElementById('contractDays').value,
        contractFrequency: document.getElementById('contractFrequency').value,
        anomalyAlert: document.getElementById('anomalyAlertEnabled').checked,
        anomalyAmount: anomalyAmountValue,
        immediateAlert: document.getElementById('immediateAlert').checked,
        
        // 사용자 정의 알림 설정
        customAlerts: {
            counterparty: {
                enabled: document.getElementById('counterpartyAlertEnabled').checked,
                keyword: document.getElementById('counterpartyKeyword').value,
                severity: document.getElementById('counterpartySeverity').value,
                channel: document.getElementById('counterpartyChannel').value
            },
            description: {
                enabled: document.getElementById('descriptionAlertEnabled').checked,
                keyword: document.getElementById('descriptionKeyword').value,
                severity: document.getElementById('descriptionSeverity').value,
                channel: document.getElementById('descriptionChannel').value
            },
            amount: {
                enabled: document.getElementById('amountAlertEnabled').checked,
                condition: document.getElementById('amountCondition').value,
                value1: document.getElementById('amountValue1').value.replace(/,/g, ''),
                value2: document.getElementById('amountValue2').value.replace(/,/g, ''),
                severity: document.getElementById('amountSeverity').value,
                channel: document.getElementById('amountChannel').value
            },
            advanced: {
                enabled: document.getElementById('advancedAlertEnabled').checked,
                pattern: document.getElementById('advancedPattern').value,
                field: document.getElementById('advancedField').value,
                severity: document.getElementById('advancedSeverity').value,
                channel: document.getElementById('advancedChannel').value
            }
        }
    };
    
    console.log('Saving alert settings:', settings);
    
    // 서버에 저장
    fetch('/alerts/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('알림 설정이 저장되었습니다.', 'success');
            // 1초 후 페이지 새로고침하여 변경사항 반영
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('설정 저장 중 오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('설정 저장 중 오류가 발생했습니다.', 'error');
    });
}

function toggleAlertSetting(settingId) {
    fetch(`/alerts/settings/${settingId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('설정 변경 중 오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('설정 변경 중 오류가 발생했습니다.', 'error');
    });
}

function deleteAlertSetting(settingId) {
    if (confirm('이 알림 설정을 삭제하시겠습니까?')) {
        fetch(`/alerts/settings/${settingId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // 알림 카드 제거
                const alertCard = document.getElementById(`alertCard_${settingId}`);
                if (alertCard) {
                    alertCard.remove();
                }
                // 기존 페이지 새로고침도 유지
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('설정 삭제 중 오류가 발생했습니다.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('설정 삭제 중 오류가 발생했습니다.', 'error');
        });
    }
}

function editAlertSetting(settingId, name, condition, severity, channel) {
    // 모달에 데이터 설정
    document.getElementById('editSettingId').value = settingId;
    document.getElementById('editAlertName').value = name;
    document.getElementById('editCondition').value = condition;
    document.getElementById('editSeverity').value = severity;
    document.getElementById('editChannel').value = channel;
    
    // 조건을 파싱해서 타입과 값 설정
    parseConditionForEdit(condition);
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('editAlertModal'));
    modal.show();
    
    // 아이콘 새로고침
    setTimeout(() => feather.replace(), 100);
}

function parseConditionForEdit(condition) {
    const conditionTypeSelect = document.getElementById('editConditionType');
    const conditionValueInput = document.getElementById('editConditionValue');
    
    // 조건 파싱 로직
    if (condition.includes('counterparty contains ')) {
        conditionTypeSelect.value = 'counterparty_contains';
        conditionValueInput.value = condition.replace('counterparty contains ', '');
    } else if (condition.includes('counterparty equals ')) {
        conditionTypeSelect.value = 'counterparty_equals';
        conditionValueInput.value = condition.replace('counterparty equals ', '');
    } else if (condition.includes('description contains ')) {
        conditionTypeSelect.value = 'description_contains';
        conditionValueInput.value = condition.replace('description contains ', '');
    } else if (condition.includes('description equals ')) {
        conditionTypeSelect.value = 'description_equals';
        conditionValueInput.value = condition.replace('description equals ', '');
    } else if (condition.includes('amount > ')) {
        conditionTypeSelect.value = 'amount_greater';
        conditionValueInput.value = condition.replace('amount > ', '');
    } else if (condition.includes('amount < ')) {
        conditionTypeSelect.value = 'amount_less';
        conditionValueInput.value = condition.replace('amount < ', '');
    } else {
        conditionTypeSelect.value = 'custom';
        conditionValueInput.value = condition;
    }
    
    updateEditConditionInput();
}

function updateEditConditionInput() {
    const conditionType = document.getElementById('editConditionType').value;
    const conditionValue = document.getElementById('editConditionValue').value;
    const conditionInput = document.getElementById('editCondition');
    const valueInput = document.getElementById('editConditionValue');
    
    // 조건 타입에 따라 placeholder 변경
    switch(conditionType) {
        case 'counterparty_contains':
            valueInput.placeholder = '예: 스타벅스';
            if (conditionValue) conditionInput.value = `counterparty contains ${conditionValue}`;
            break;
        case 'counterparty_equals':
            valueInput.placeholder = '예: KB국민은행';
            if (conditionValue) conditionInput.value = `counterparty equals ${conditionValue}`;
            break;
        case 'description_contains':
            valueInput.placeholder = '예: 급여';
            if (conditionValue) conditionInput.value = `description contains ${conditionValue}`;
            break;
        case 'description_equals':
            valueInput.placeholder = '예: 월급여';
            if (conditionValue) conditionInput.value = `description equals ${conditionValue}`;
            break;
        case 'amount_greater':
            valueInput.placeholder = '예: 500000';
            if (conditionValue) conditionInput.value = `amount > ${conditionValue}`;
            break;
        case 'amount_less':
            valueInput.placeholder = '예: 100000';
            if (conditionValue) conditionInput.value = `amount < ${conditionValue}`;
            break;
        case 'custom':
            valueInput.placeholder = '직접 조건을 입력하세요';
            conditionInput.value = conditionValue;
            break;
        default:
            valueInput.placeholder = '조건에 맞는 값을 입력하세요';
            conditionInput.value = '';
    }
}

// 수정 모달의 조건 값 변경 시 실시간 업데이트
document.addEventListener('DOMContentLoaded', function() {
    const editConditionValue = document.getElementById('editConditionValue');
    if (editConditionValue) {
        editConditionValue.addEventListener('input', updateEditConditionInput);
    }
});

// 시스템 알림 생성 함수들
function createBudgetAlert() {
    const threshold = document.getElementById('budgetThreshold').value;
    const frequency = document.getElementById('budgetFrequency').value;
    const severity = document.getElementById('budgetSeverity').value;
    const channel = document.getElementById('budgetChannel').value;
    
    if (!threshold) {
        showToast('임계치를 설정해주세요.', 'warning');
        return;
    }
    
    // 중복 검사
    checkSystemDuplicateAndCreate('budget', `${threshold}%`, {
        name: `예산 초과 알림: ${threshold}%`,
        condition: `budget threshold ${threshold}%`,
        condition_type: 'budget_threshold',
        condition_field: 'budget',
        condition_value: threshold,
        severity: severity,
        channel: channel,
        alert_type: 'budget',
        frequency: frequency
    });
}

function createContractAlert() {
    const days = document.getElementById('contractDays').value;
    const frequency = document.getElementById('contractFrequency').value;
    const severity = document.getElementById('contractSeverity').value;
    const channel = document.getElementById('contractChannel').value;
    
    if (!days) {
        showToast('사전 알림 일수를 설정해주세요.', 'warning');
        return;
    }
    
    // 중복 검사
    checkSystemDuplicateAndCreate('contract', `${days}일`, {
        name: `계약 만료 알림: ${days}일 전`,
        condition: `contract expiry ${days} days`,
        condition_type: 'contract_expiry',
        condition_field: 'contract',
        condition_value: days,
        severity: severity,
        channel: channel,
        alert_type: 'contract',
        frequency: frequency
    });
}

function createAnomalyAlert() {
    const amount = document.getElementById('anomalyAmount').value.replace(/,/g, '');
    const severity = document.getElementById('anomalySeverity').value;
    const channel = document.getElementById('anomalyChannel').value;
    const immediate = document.getElementById('immediateAlert').checked;
    
    if (!amount || isNaN(amount)) {
        showToast('올바른 이상 금액을 입력해주세요.', 'warning');
        return;
    }
    
    // 중복 검사
    checkSystemDuplicateAndCreate('anomaly', amount, {
        name: `이상거래 알림: ${parseInt(amount).toLocaleString()}원 초과`,
        condition: `transaction amount > ${amount}`,
        condition_type: 'amount_threshold',
        condition_field: 'amount',
        condition_value: amount,
        severity: severity,
        channel: channel,
        alert_type: 'anomaly',
        immediate: immediate
    });
}

// 시스템 알림 중복 검사 및 생성
function checkSystemDuplicateAndCreate(type, checkValue, alertData) {
    // 서버에 중복 검사 및 생성 요청
    fetch('/alerts/create-system', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type,
            checkValue: checkValue,
            alertData: alertData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.isDuplicate) {
                showToast(`중복된 조건이 있지만 새로운 알림을 생성했습니다: ${data.message}`, 'warning');
            } else {
                showToast('새로운 시스템 알림이 생성되었습니다.', 'success');
            }
            
            // 시스템 알림 카드 추가
            addSystemAlertCard(data.alertId, alertData);
            
            // 폼 초기화
            resetSystemFormFields(type);
        } else {
            showToast(data.error || '알림 생성 중 오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('알림 생성 중 오류가 발생했습니다.', 'error');
    });
}

// 시스템 알림 카드 추가
function addSystemAlertCard(alertId, alertData) {
    const cardsContainer = document.getElementById('systemAlertCards');
    
    const typeText = alertData.alert_type === 'budget' ? '예산' : 
                     alertData.alert_type === 'contract' ? '계약' : '이상거래';
    
    const cardHtml = `
        <div class="alert-card-item mb-3" id="alertCard_${alertId}">
            <div class="card border-start border-4 border-primary">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-1 small">${alertData.name}</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input form-check-input-sm" type="checkbox" checked
                                   onchange="toggleAlertSetting(${alertId})">
                        </div>
                    </div>
                    <p class="card-text text-muted small mb-2">${alertData.condition}</p>
                    <div class="mb-2">
                        <span class="badge badge-sm bg-${alertData.severity === 'info' ? 'info' : alertData.severity === 'warning' ? 'warning' : 'danger'} me-1">
                            ${alertData.severity.charAt(0).toUpperCase() + alertData.severity.slice(1)}
                        </span>
                        <span class="badge badge-sm bg-secondary me-1">
                            ${alertData.channel.charAt(0).toUpperCase() + alertData.channel.slice(1)}
                        </span>
                        <span class="badge badge-sm bg-primary">
                            ${typeText}
                        </span>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteAlertSetting(${alertId})" title="삭제">
                        <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                        삭제
                    </button>
                </div>
            </div>
        </div>
    `;
    
    cardsContainer.insertAdjacentHTML('beforeend', cardHtml);
    
    // 아이콘 새로고침
    setTimeout(() => feather.replace(), 100);
}

// 시스템 알림 폼 필드 초기화
function resetSystemFormFields(type) {
    switch(type) {
        case 'budget':
            document.getElementById('budgetThreshold').value = '90';
            document.getElementById('budgetFrequency').value = 'weekly';
            break;
        case 'contract':
            document.getElementById('contractDays').value = '30';
            document.getElementById('contractFrequency').value = 'daily';
            break;
        case 'anomaly':
            document.getElementById('anomalyAmount').value = '';
            document.getElementById('immediateAlert').checked = false;
            break;
    }
}

// 개별 알림 생성 함수들
function createCounterpartyAlert() {
    const keyword = document.getElementById('counterpartyKeyword').value.trim();
    const severity = document.getElementById('counterpartySeverity').value;
    const channel = document.getElementById('counterpartyChannel').value;
    
    if (!keyword) {
        showToast('키워드를 입력해주세요.', 'warning');
        return;
    }
    
    // 중복 검사
    checkDuplicateAndCreate('counterparty', keyword, {
        name: `거래처 포함: ${keyword}`,
        condition: `counterparty contains ${keyword}`,
        condition_type: 'contains',
        condition_field: 'counterparty',
        condition_value: keyword,
        severity: severity,
        channel: channel
    });
}

function createDescriptionAlert() {
    const keyword = document.getElementById('descriptionKeyword').value.trim();
    const severity = document.getElementById('descriptionSeverity').value;
    const channel = document.getElementById('descriptionChannel').value;
    
    if (!keyword) {
        showToast('거래내용을 입력해주세요.', 'warning');
        return;
    }
    
    // 중복 검사
    checkDuplicateAndCreate('description', keyword, {
        name: `거래내용 일치: ${keyword}`,
        condition: `description equals ${keyword}`,
        condition_type: 'equals',
        condition_field: 'description',
        condition_value: keyword,
        severity: severity,
        channel: channel
    });
}

function createAmountAlert() {
    const condition = document.getElementById('amountCondition').value;
    const value1 = document.getElementById('amountValue1').value.replace(/,/g, '');
    const value2 = document.getElementById('amountValue2').value.replace(/,/g, '');
    const severity = document.getElementById('amountSeverity').value;
    const channel = 'app'; // 금액 알림은 앱 내 알림만
    
    if (!value1 || isNaN(value1)) {
        showToast('올바른 금액을 입력해주세요.', 'warning');
        return;
    }
    
    let alertData = {};
    
    if (condition === 'greater') {
        alertData = {
            name: `금액 초과: ${parseInt(value1).toLocaleString()}원`,
            condition: `amount > ${value1}`,
            condition_type: 'amount_range',
            condition_field: 'amount',
            condition_value: `${value1},9999999999`,
            severity: severity,
            channel: channel
        };
    } else if (condition === 'less') {
        alertData = {
            name: `금액 미만: ${parseInt(value1).toLocaleString()}원`,
            condition: `amount < ${value1}`,
            condition_type: 'amount_range',
            condition_field: 'amount',
            condition_value: `0,${value1}`,
            severity: severity,
            channel: channel
        };
    } else if (condition === 'between') {
        if (!value2 || isNaN(value2)) {
            showToast('범위의 최대값을 입력해주세요.', 'warning');
            return;
        }
        alertData = {
            name: `금액 범위: ${parseInt(value1).toLocaleString()}~${parseInt(value2).toLocaleString()}원`,
            condition: `amount range ${value1},${value2}`,
            condition_type: 'amount_range',
            condition_field: 'amount',
            condition_value: `${value1},${value2}`,
            severity: severity,
            channel: channel
        };
    }
    
    // 중복 검사
    checkDuplicateAndCreate('amount', alertData.condition_value, alertData);
}

function createAdvancedAlert() {
    const pattern = document.getElementById('advancedPattern').value.trim();
    const field = document.getElementById('advancedField').value;
    const severity = document.getElementById('advancedSeverity').value;
    const channel = document.getElementById('advancedChannel').value;
    
    if (!pattern) {
        showToast('정규식 패턴을 입력해주세요.', 'warning');
        return;
    }
    
    // 정규식 유효성 검사
    try {
        new RegExp(pattern);
    } catch (e) {
        showToast('올바르지 않은 정규식 패턴입니다.', 'error');
        return;
    }
    
    // 중복 검사
    checkDuplicateAndCreate('advanced', pattern, {
        name: `고급 패턴: ${pattern.slice(0, 20)}...`,
        condition: `${field} regex ${pattern}`,
        condition_type: 'regex',
        condition_field: field,
        condition_value: pattern,
        severity: severity,
        channel: channel
    });
}

// 중복 검사 및 알림 생성
function checkDuplicateAndCreate(type, checkValue, alertData) {
    // 서버에 중복 검사 및 생성 요청
    fetch('/alerts/create-custom', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type,
            checkValue: checkValue,
            alertData: alertData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.isDuplicate) {
                showToast(`중복된 조건이 있지만 새로운 알림을 생성했습니다: ${data.message}`, 'warning');
            } else {
                showToast('새로운 알림이 생성되었습니다.', 'success');
            }
            
            // 알림 카드 추가
            addAlertCard(data.alertId, alertData);
            
            // 폼 초기화
            resetFormFields(type);
        } else {
            showToast(data.error || '알림 생성 중 오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('알림 생성 중 오류가 발생했습니다.', 'error');
    });
}

// 알림 카드 추가
function addAlertCard(alertId, alertData) {
    const cardsContainer = document.getElementById('customAlertCards');
    
    const cardHtml = `
        <div class="alert-card-item mb-3" id="alertCard_${alertId}">
            <div class="card border-start border-4 border-success">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-1 small">${alertData.name}</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input form-check-input-sm" type="checkbox" checked
                                   onchange="toggleAlertSetting(${alertId})">
                        </div>
                    </div>
                    <p class="card-text text-muted small mb-2">${alertData.condition}</p>
                    <div class="mb-2">
                        <span class="badge badge-sm bg-${alertData.severity === 'info' ? 'info' : alertData.severity === 'warning' ? 'warning' : 'danger'} me-1">
                            ${alertData.severity.charAt(0).toUpperCase() + alertData.severity.slice(1)}
                        </span>
                        <span class="badge badge-sm bg-secondary">
                            ${alertData.channel.charAt(0).toUpperCase() + alertData.channel.slice(1)}
                        </span>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteAlertSetting(${alertId})" title="삭제">
                        <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                        삭제
                    </button>
                </div>
            </div>
        </div>
    `;
    
    cardsContainer.insertAdjacentHTML('beforeend', cardHtml);
    
    // 아이콘 새로고침
    setTimeout(() => feather.replace(), 100);
}

// 폼 필드 초기화
function resetFormFields(type) {
    switch(type) {
        case 'counterparty':
            document.getElementById('counterpartyKeyword').value = '';
            break;
        case 'description':
            document.getElementById('descriptionKeyword').value = '';
            break;
        case 'amount':
            document.getElementById('amountValue1').value = '';
            document.getElementById('amountValue2').value = '';
            break;
        case 'advanced':
            document.getElementById('advancedPattern').value = '';
            break;
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}
