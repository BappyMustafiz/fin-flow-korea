{% extends "layout.html" %}

{% block title %}리포트 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">재무 리포트</h1>
        <p class="text-muted">현금흐름, 예산 대비 실적, 부서별 분석 리포트</p>
    </div>
</div>

<!-- Report Period Selection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="reportType" class="form-label">리포트 유형</label>
                        <select class="form-select" id="reportType">
                            <option value="cashflow">현금흐름</option>
                            <option value="budget">예산 대비 실적</option>
                            <option value="department">부서별 분석</option>
                            <option value="vendor">거래처별 분석</option>
                            <option value="contract">계약 관점 분석</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="startDate" class="form-label">시작일</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-2">
                        <label for="endDate" class="form-label">종료일</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-2">
                        <label for="period" class="form-label">기간</label>
                        <select class="form-select" id="period">
                            <option value="daily">일별</option>
                            <option value="weekly">주별</option>
                            <option value="monthly" selected>월별</option>
                            <option value="quarterly">분기별</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary" onclick="generateReport()">
                            <i data-feather="bar-chart-2" class="me-1"></i>생성
                        </button>
                    </div>
                    <div class="col-md-1">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i data-feather="download" class="me-1"></i>내보내기
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                                    <i data-feather="file-text" class="me-2" style="width: 14px; height: 14px;"></i>PDF
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                                    <i data-feather="grid" class="me-2" style="width: 14px; height: 14px;"></i>Excel
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportReport('csv')">
                                    <i data-feather="file" class="me-2" style="width: 14px; height: 14px;"></i>CSV
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Cash Flow Report -->
<div class="report-section" id="cashflowReport">
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="trending-up" class="me-2"></i>
                        현금흐름 추이
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                    <canvas id="cashflowChart"></canvas>
                </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="dollar-sign" class="me-2"></i>
                        월별 요약
                    </h5>
                </div>
                <div class="card-body">
                    
                    {% set ns = namespace(total_income=0, total_expense=0) %}
                    {% for item in monthly_flow %}
                        {% set ns.total_income = ns.total_income + item.income %}
                        {% set ns.total_expense = ns.total_expense + item.expense %}
                    {% endfor %}
                    
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">총 수입</span>
                            <strong class="text-success">₩{{ "{:,.0f}".format(ns.total_income) }}</strong>
                        </div>
                    </div>
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">총 지출</span>
                            <strong class="text-danger">₩{{ "{:,.0f}".format(ns.total_expense | abs) }}</strong>
                        </div>
                    </div>
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">순현금흐름</span>
                            {% set net_flow = ns.total_income + ns.total_expense %}
                            <strong class="{% if net_flow > 0 %}text-success{% elif net_flow < 0 %}text-danger{% else %}text-muted{% endif %}">
                                ₩{{ "{:,.0f}".format(net_flow) }}
                            </strong>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">평균 월 지출</span>
                            {% set avg_expense = (ns.total_expense / (monthly_flow | length if monthly_flow | length > 0 else 1)) | abs %}
                            <strong>₩{{ "{:,.0f}".format(avg_expense) }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department Spending Report -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="users" class="me-2"></i>
                    부서별 지출 현황
                </h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="deptSpendingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="briefcase" class="me-2"></i>
                    상위 거래처 (TOP 10)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>순위</th>
                                <th>거래처</th>
                                <th>거래횟수</th>
                                <th class="text-end">총 금액</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vendor in top_vendors %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ vendor.name }}</td>
                                <td>{{ vendor.count }}회</td>
                                <td class="text-end text-danger">₩{{ "{:,.0f}".format(vendor.total | abs) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    데이터가 없습니다.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Budget vs Actual Report -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="target" class="me-2"></i>
                    예산 대비 실적 분석
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>부서</th>
                                <th class="text-end">예산</th>
                                <th class="text-end">실적</th>
                                <th class="text-end">차이</th>
                                <th class="text-center">달성률</th>
                                <th class="text-center">상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in dept_spending %}
                            {% set budget = 10000000 %}  <!-- 샘플 예산 -->
                            {% set actual = dept.total | abs %}
                            {% set diff = budget - actual %}
                            {% set rate = (actual / budget * 100) if budget > 0 else 0 %}
                            <tr>
                                <td>{{ dept.name }}</td>
                                <td class="text-end">₩{{ "{:,.0f}".format(budget) }}</td>
                                <td class="text-end text-danger">₩{{ "{:,.0f}".format(actual) }}</td>
                                <td class="text-end {% if diff > 0 %}text-success{% elif diff < 0 %}text-danger{% else %}text-muted{% endif %}">₩{{ "{:,.0f}".format(diff) }}</td>
                                <td class="text-center">
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar {% if rate > 100 %}bg-danger{% elif rate > 90 %}bg-warning{% else %}bg-success{% endif %}" 
                                             style="width: {{ [rate, 100] | min }}%">
                                            {{ "%.1f" | format(rate) }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if rate > 100 %}
                                        <span class="badge bg-danger">초과</span>
                                    {% elif rate > 90 %}
                                        <span class="badge bg-warning">주의</span>
                                    {% else %}
                                        <span class="badge bg-success">양호</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    부서별 지출 데이터가 없습니다.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contract Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="file-text" class="me-2"></i>
                    계약 관점 분석
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i data-feather="info" class="me-2"></i>
                    계약 데이터와 관련 지출을 연계하여 분석합니다. 계약 만료 임박 알림 기능도 포함됩니다.
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="text-primary">12건</h4>
                                <p class="mb-0">활성 계약</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="text-warning">3건</h4>
                                <p class="mb-0">만료 임박 (30일 이내)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="text-success">85%</h4>
                                <p class="mb-0">계약 이행률</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeReports();
});

function initializeReports() {
    // 현금흐름 차트 초기화
    initCashflowChart();
    
    // 부서별 지출 차트 초기화
    initDeptSpendingChart();
    
    // 날짜 기본값 설정
    const endDate = new Date();
    const startDate = new Date();
    startDate.setMonth(startDate.getMonth() - 12);
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

function initCashflowChart() {
    const ctx = document.getElementById('cashflowChart').getContext('2d');
    const monthlyData = {{ monthly_flow | tojson }};
    
    const labels = monthlyData.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`);
    const incomeData = monthlyData.map(d => d.income || 0);
    const expenseData = monthlyData.map(d => Math.abs(d.expense || 0));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '수입',
                data: incomeData,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: '#28a745',
                borderWidth: 1
            }, {
                label: '지출',
                data: expenseData,
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: '#dc3545',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + '원';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '원';
                        }
                    }
                }
            }
        }
    });
}

function initDeptSpendingChart() {
    const ctx = document.getElementById('deptSpendingChart').getContext('2d');
    const deptData = {{ dept_spending | tojson }};
    
    if (deptData && deptData.length > 0) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: deptData.map(d => d.name),
                datasets: [{
                    data: deptData.map(d => Math.abs(d.total)),
                    backgroundColor: [
                        '#007bff', // 밝은 파랑
                        '#dc3545', // 빨강
                        '#28a745', // 초록
                        '#ffc107', // 노랑
                        '#fd7e14', // 오렌지
                        '#6f42c1'  // 보라
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed.toLocaleString() + '원 (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
}

function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const period = document.getElementById('period').value;
    
    // 입력 검증
    if (!startDate || !endDate) {
        showToast('시작일과 종료일을 모두 선택해주세요.', 'warning');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        showToast('시작일은 종료일보다 이전이어야 합니다.', 'warning');
        return;
    }
    
    showToast('리포트를 생성하고 있습니다...', 'info');
    
    // 서버에 AJAX 요청
    const params = new URLSearchParams({
        type: reportType,
        start_date: startDate,
        end_date: endDate,
        period: period
    });
    
    fetch(`/reports/data?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCharts(data.data, reportType);
                showToast('리포트가 생성되었습니다.', 'success');
            } else {
                showToast(`리포트 생성 실패: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('리포트 생성 중 오류가 발생했습니다.', 'danger');
        });
}

function updateCharts(data, reportType) {
    console.log('Updating charts for report type:', reportType, 'with data:', data);
    
    if (reportType === 'cashflow' && data.cashflow) {
        updateCashflowChart(data.cashflow);
    } else if (reportType === 'department' && data.department) {
        updateDepartmentChart(data.department);
    } else if (reportType === 'vendor' && data.vendor) {
        updateVendorChart(data.vendor);
    } else {
        console.log('No matching report type or data found');
    }
}

function updateCashflowChart(cashflowData) {
    const ctx = document.getElementById('cashflowChart');
    if (!ctx) {
        console.log('Cashflow chart canvas not found');
        return;
    }
    
    console.log('Updating cashflow chart with data:', cashflowData);
    
    const labels = cashflowData.map(item => item.period);
    const incomeData = cashflowData.map(item => item.income);
    const expenseData = cashflowData.map(item => item.expense);
    const netData = cashflowData.map(item => item.net);
    
    // 기존 차트 파괴
    if (window.cashflowChart) {
        window.cashflowChart.destroy();
    }
    
    // 새 차트 생성
    window.cashflowChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '수입',
                data: incomeData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: false
            }, {
                label: '지출',
                data: expenseData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: false
            }, {
                label: '순현금흐름',
                data: netData,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + '원';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '원';
                        }
                    }
                }
            }
        }
    });
}

function updateDepartmentChart(departmentData) {
    const ctx = document.getElementById('deptSpendingChart');
    if (!ctx) {
        console.log('Department chart canvas not found');
        return;
    }
    
    const labels = departmentData.map(item => item.name);
    const data = departmentData.map(item => item.total);
    
    // 기존 차트 파괴
    if (window.deptSpendingChart) {
        window.deptSpendingChart.destroy();
    }
    
    // 새 차트 생성
    window.deptSpendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed.toLocaleString() + '원 (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function updateVendorChart(vendorData) {
    // 거래처 차트는 테이블로 표시하므로 테이블 업데이트
    updateVendorTable(vendorData);
}

function updateVendorTable(vendorData) {
    const tableBody = document.querySelector('.table tbody');
    if (!tableBody) return;
    
    if (!vendorData || vendorData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-3">
                    선택한 기간에 거래 데이터가 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    vendorData.forEach((vendor, index) => {
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>${vendor.name}</td>
                <td>${vendor.count}회</td>
                <td class="text-end text-danger">₩${vendor.total.toLocaleString()}</td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}

function exportReport(format) {
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const period = document.getElementById('period').value;
    
    // 내보내기 URL 생성
    const params = new URLSearchParams({
        type: reportType,
        start_date: startDate,
        end_date: endDate,
        period: period,
        format: format
    });
    
    showToast(`${format.toUpperCase()} 형식으로 내보내고 있습니다...`, 'info');
    
    // 파일 다운로드
    const url = `/reports/export?${params.toString()}`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `financial_report_${new Date().toISOString().split('T')[0]}.${format}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        showToast('리포트 파일이 다운로드되었습니다.', 'success');
    }, 1000);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// 페이지 로드시 기본 날짜 설정
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    document.getElementById('startDate').value = oneYearAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    // 페이지 로드시 기본 리포트 생성 (약간의 지연)
    setTimeout(() => {
        console.log('Loading default report...');
        generateReport();
    }, 500);
});
</script>
{% endblock %}
