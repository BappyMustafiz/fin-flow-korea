{% extends "layout.html" %}

{% block title %}리포트 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">재무 리포트</h1>
        <p class="text-muted">손익계산서, 현금흐름, 예산분석, 부서별/거래처별/카테고리별 분석</p>
    </div>
</div>

<!-- Report Configuration -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">
            <i data-feather="settings" class="me-2"></i>
            리포트 설정
        </h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label for="reportType" class="form-label">리포트 유형</label>
                <select class="form-select" id="reportType" onchange="onReportTypeChange()">
                    <option value="pl">손익계산서</option>
                    <option value="cashflow">현금흐름표</option>
                    <option value="budget">예산 vs 실적</option>
                    <option value="department">부서별 손익</option>
                    <option value="vendor">거래처별 분석</option>
                    <option value="category">카테고리별 분석</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="startDate" class="form-label">시작일</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">종료일</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary d-block w-100" onclick="generateReport()">
                    <i data-feather="bar-chart-2" class="me-1"></i>리포트 생성
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Content -->
<div id="reportContent" style="display: none;">
    <!-- P&L Statement -->
    <div id="plReport" class="report-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="trending-up" class="me-2"></i>손익계산서</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <canvas id="plChart" style="height: 300px;"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <div class="table-responsive">
                            <table class="table table-striped" id="plTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>구분</th>
                                        <th class="text-end">금액</th>
                                        <th class="text-end">비중</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Flow Statement -->
    <div id="cashflowReport" class="report-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="dollar-sign" class="me-2"></i>현금흐름표</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <canvas id="cashflowChart" style="height: 350px;"></canvas>
                    </div>
                    <div class="col-lg-4">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm" id="cashflowTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>기간</th>
                                        <th class="text-end">순현금흐름</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget vs Actual -->
    <div id="budgetReport" class="report-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="target" class="me-2"></i>예산 vs 실적</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <canvas id="budgetChart" style="height: 350px;"></canvas>
                    </div>
                    <div class="col-lg-4">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm" id="budgetTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>부서</th>
                                        <th class="text-end">예산</th>
                                        <th class="text-end">실적</th>
                                        <th class="text-end">차이</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Analysis -->
    <div id="departmentReport" class="report-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="users" class="me-2"></i>부서별 손익</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <canvas id="departmentChart" style="height: 300px;"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <div class="table-responsive">
                            <table class="table table-striped" id="departmentTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>부서</th>
                                        <th class="text-end">수익</th>
                                        <th class="text-end">비용</th>
                                        <th class="text-end">손익</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Analysis -->
    <div id="vendorReport" class="report-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="briefcase" class="me-2"></i>거래처별 분석</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <canvas id="vendorChart" style="height: 300px;"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <div class="table-responsive">
                            <table class="table table-striped" id="vendorTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>순위</th>
                                        <th>거래처</th>
                                        <th class="text-end">거래횟수</th>
                                        <th class="text-end">거래금액</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Analysis -->
    <div id="categoryReport" class="report-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="tag" class="me-2"></i>카테고리별 분석</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <canvas id="categoryChart" style="height: 300px;"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <div class="table-responsive">
                            <table class="table table-striped" id="categoryTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>카테고리</th>
                                        <th class="text-end">거래건수</th>
                                        <th class="text-end">거래금액</th>
                                        <th class="text-end">비중</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loadingState" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">로딩 중...</span>
    </div>
    <p class="mt-3 text-muted">리포트를 생성하고 있습니다...</p>
</div>

<!-- No Data State -->
<div id="noDataState" class="text-center py-5" style="display: none;">
    <i data-feather="alert-circle" class="text-muted" style="width: 48px; height: 48px;"></i>
    <h5 class="mt-3 text-muted">데이터가 없습니다</h5>
    <p class="text-muted">선택한 기간에 해당하는 거래 데이터가 없습니다.</p>
</div>

<script>
let currentChart = null;

// 페이지 로드 시 기본 날짜 설정
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const startOfYear = new Date(today.getFullYear(), 0, 1);
    
    document.getElementById('startDate').value = startOfYear.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    // 기본 리포트 로드
    generateReport();
});

function onReportTypeChange() {
    // 리포트 타입이 변경되면 자동으로 리포트 생성
    generateReport();
}

function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('시작일과 종료일을 선택해주세요.');
        return;
    }
    
    showLoadingState();
    
    // API 호출
    fetch(`/reports/data?report_type=${reportType}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReport(reportType, data.data);
            } else {
                showError(data.error || '리포트 생성 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('서버 연결 오류가 발생했습니다.');
        });
}

function showLoadingState() {
    document.getElementById('reportContent').style.display = 'none';
    document.getElementById('noDataState').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';
}

function displayReport(reportType, data) {
    // 모든 리포트 섹션 숨기기
    document.querySelectorAll('.report-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // 로딩 상태 숨기기
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('noDataState').style.display = 'none';
    
    // 기존 차트 제거
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
    
    // 해당 리포트 표시
    document.getElementById('reportContent').style.display = 'block';
    
    switch(reportType) {
        case 'pl':
            displayPLReport(data);
            break;
        case 'cashflow':
            displayCashflowReport(data);
            break;
        case 'budget':
            displayBudgetReport(data);
            break;
        case 'department':
            displayDepartmentReport(data);
            break;
        case 'vendor':
            displayVendorReport(data);
            break;
        case 'category':
            displayCategoryReport(data);
            break;
    }
}

function displayPLReport(data) {
    document.getElementById('plReport').style.display = 'block';
    
    if (!data.pl || data.pl.length === 0) {
        showNoDataState();
        return;
    }
    
    createPLChart(data.pl);
    createPLTable(data.pl);
}

function displayCashflowReport(data) {
    document.getElementById('cashflowReport').style.display = 'block';
    
    if (!data.cashflow || data.cashflow.length === 0) {
        showNoDataState();
        return;
    }
    
    createCashflowChart(data.cashflow);
    createCashflowTable(data.cashflow);
}

function displayBudgetReport(data) {
    document.getElementById('budgetReport').style.display = 'block';
    
    if (!data.budget || data.budget.length === 0) {
        showNoDataState();
        return;
    }
    
    createBudgetChart(data.budget);
    createBudgetTable(data.budget);
}

function displayDepartmentReport(data) {
    document.getElementById('departmentReport').style.display = 'block';
    
    if (!data.department || data.department.length === 0) {
        showNoDataState();
        return;
    }
    
    createDepartmentChart(data.department);
    createDepartmentTable(data.department);
}

function displayVendorReport(data) {
    document.getElementById('vendorReport').style.display = 'block';
    
    if (!data.vendor || data.vendor.length === 0) {
        showNoDataState();
        return;
    }
    
    createVendorChart(data.vendor);
    createVendorTable(data.vendor);
}

function displayCategoryReport(data) {
    document.getElementById('categoryReport').style.display = 'block';
    
    if (!data.category || data.category.length === 0) {
        showNoDataState();
        return;
    }
    
    createCategoryChart(data.category);
    createCategoryTable(data.category);
}

function createPLChart(data) {
    const ctx = document.getElementById('plChart');
    if (!ctx) return;
    
    const totalRevenue = data.filter(item => item.type === 'revenue').reduce((sum, item) => sum + Math.abs(item.amount), 0);
    const totalCosts = data.filter(item => item.type === 'cost').reduce((sum, item) => sum + Math.abs(item.amount), 0);
    const netProfit = totalRevenue - totalCosts;
    
    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['수익', '비용', '순이익'],
            datasets: [{
                data: [totalRevenue, totalCosts, Math.abs(netProfit)],
                backgroundColor: ['#28a745', '#dc3545', netProfit >= 0 ? '#17a2b8' : '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const sign = context.dataIndex === 2 ? (netProfit >= 0 ? '+' : '-') : '';
                            return context.label + ': ' + sign + '₩' + value.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₩' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createPLTable(data) {
    const tableBody = document.querySelector('#plTable tbody');
    if (!tableBody) return;
    
    const totalRevenue = data.filter(item => item.type === 'revenue').reduce((sum, item) => sum + Math.abs(item.amount), 0);
    const totalCosts = data.filter(item => item.type === 'cost').reduce((sum, item) => sum + Math.abs(item.amount), 0);
    const netProfit = totalRevenue - totalCosts;
    const total = totalRevenue + totalCosts;
    
    const revenuePercent = total > 0 ? (totalRevenue / total * 100).toFixed(1) : 0;
    const costsPercent = total > 0 ? (totalCosts / total * 100).toFixed(1) : 0;
    
    const html = `
        <tr>
            <td><strong>총 수익</strong></td>
            <td class="text-end text-success"><strong>₩${totalRevenue.toLocaleString()}</strong></td>
            <td class="text-end">${revenuePercent}%</td>
        </tr>
        <tr>
            <td><strong>총 비용</strong></td>
            <td class="text-end text-danger"><strong>₩${totalCosts.toLocaleString()}</strong></td>
            <td class="text-end">${costsPercent}%</td>
        </tr>
        <tr class="table-warning">
            <td><strong>순이익</strong></td>
            <td class="text-end ${netProfit >= 0 ? 'text-success' : 'text-danger'}"><strong>${netProfit >= 0 ? '+' : ''}₩${Math.abs(netProfit).toLocaleString()}</strong></td>
            <td class="text-end">-</td>
        </tr>
    `;
    
    tableBody.innerHTML = html;
}

function createCashflowChart(data) {
    const ctx = document.getElementById('cashflowChart');
    if (!ctx) return;
    
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(item => item.period),
            datasets: [
                {
                    label: '수입',
                    data: data.map(item => item.income),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: false
                },
                {
                    label: '지출',
                    data: data.map(item => item.expense),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: false
                },
                {
                    label: '순현금흐름',
                    data: data.map(item => item.net),
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₩' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₩' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createCashflowTable(data) {
    const tableBody = document.querySelector('#cashflowTable tbody');
    if (!tableBody) return;
    
    const html = data.map(item => `
        <tr>
            <td>${item.period}</td>
            <td class="text-end ${item.net >= 0 ? 'text-success' : 'text-danger'}">
                ${item.net >= 0 ? '+' : ''}₩${Math.abs(item.net).toLocaleString()}
            </td>
        </tr>
    `).join('');
    
    tableBody.innerHTML = html;
}

function createBudgetChart(data) {
    const ctx = document.getElementById('budgetChart');
    if (!ctx) return;
    
    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.department),
            datasets: [
                {
                    label: '예산',
                    data: data.map(item => item.budget),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)'
                },
                {
                    label: '실적',
                    data: data.map(item => item.actual),
                    backgroundColor: 'rgba(255, 99, 132, 0.8)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₩' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₩' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createBudgetTable(data) {
    const tableBody = document.querySelector('#budgetTable tbody');
    if (!tableBody) return;
    
    const html = data.map(item => {
        const difference = item.actual - item.budget;
        const colorClass = difference <= 0 ? 'text-success' : 'text-danger';
        
        return `
            <tr>
                <td>${item.department}</td>
                <td class="text-end">₩${item.budget.toLocaleString()}</td>
                <td class="text-end">₩${item.actual.toLocaleString()}</td>
                <td class="text-end ${colorClass}">${difference >= 0 ? '+' : ''}₩${Math.abs(difference).toLocaleString()}</td>
            </tr>
        `;
    }).join('');
    
    tableBody.innerHTML = html;
}

function createDepartmentChart(data) {
    const ctx = document.getElementById('departmentChart');
    if (!ctx) return;
    
    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.name),
            datasets: [
                {
                    label: '수익',
                    data: data.map(item => item.revenue),
                    backgroundColor: 'rgba(40, 167, 69, 0.8)'
                },
                {
                    label: '비용',
                    data: data.map(item => item.cost),
                    backgroundColor: 'rgba(220, 53, 69, 0.8)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₩' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₩' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createDepartmentTable(data) {
    const tableBody = document.querySelector('#departmentTable tbody');
    if (!tableBody) return;
    
    const html = data.map(item => {
        const profit = item.revenue - item.cost;
        const profitClass = profit >= 0 ? 'text-success' : 'text-danger';
        
        return `
            <tr>
                <td>${item.name}</td>
                <td class="text-end text-success">₩${item.revenue.toLocaleString()}</td>
                <td class="text-end text-danger">₩${item.cost.toLocaleString()}</td>
                <td class="text-end ${profitClass}">${profit >= 0 ? '+' : ''}₩${Math.abs(profit).toLocaleString()}</td>
            </tr>
        `;
    }).join('');
    
    tableBody.innerHTML = html;
}

function createVendorChart(data) {
    const ctx = document.getElementById('vendorChart');
    if (!ctx) return;
    
    const topVendors = data.slice(0, 10);
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#AFCBDE', '#FFEB3B'];
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: topVendors.map(item => item.name),
            datasets: [{
                data: topVendors.map(item => Math.abs(item.total)),
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const originalValue = topVendors[context.dataIndex].total;
                            const sign = originalValue >= 0 ? '+' : '';
                            return context.label + ': ' + sign + '₩' + originalValue.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createVendorTable(data) {
    const tableBody = document.querySelector('#vendorTable tbody');
    if (!tableBody) return;
    
    const html = data.map((vendor, index) => {
        const colorClass = vendor.total >= 0 ? 'text-success' : 'text-danger';
        const sign = vendor.total >= 0 ? '+' : '';
        
        return `
            <tr>
                <td>${index + 1}</td>
                <td>${vendor.name}</td>
                <td class="text-end">${vendor.count}회</td>
                <td class="text-end ${colorClass}">${sign}₩${vendor.total.toLocaleString()}</td>
            </tr>
        `;
    }).join('');
    
    tableBody.innerHTML = html;
}

function createCategoryChart(data) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => item.name),
            datasets: [{
                data: data.map(item => Math.abs(item.total)),
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const originalValue = data[context.dataIndex].total;
                            const sign = originalValue >= 0 ? '+' : '';
                            return context.label + ': ' + sign + '₩' + originalValue.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createCategoryTable(data) {
    const tableBody = document.querySelector('#categoryTable tbody');
    if (!tableBody) return;
    
    const totalAbs = data.reduce((sum, item) => sum + Math.abs(item.total), 0);
    
    const html = data.map(category => {
        const percentage = totalAbs > 0 ? (Math.abs(category.total) / totalAbs * 100).toFixed(1) : 0;
        const colorClass = category.total >= 0 ? 'text-success' : 'text-danger';
        const sign = category.total >= 0 ? '+' : '';
        
        return `
            <tr>
                <td>${category.name}</td>
                <td class="text-end">${category.count}건</td>
                <td class="text-end ${colorClass}">${sign}₩${category.total.toLocaleString()}</td>
                <td class="text-end">${percentage}%</td>
            </tr>
        `;
    }).join('');
    
    tableBody.innerHTML = html;
}

function showNoDataState() {
    document.getElementById('reportContent').style.display = 'none';
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('noDataState').style.display = 'block';
}

function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    alert('오류: ' + message);
}
</script>
{% endblock %}