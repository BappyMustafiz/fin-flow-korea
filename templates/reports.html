{% extends "layout.html" %}

{% block title %}리포트 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">재무 리포트</h1>
        <p class="text-muted">현금흐름, 예산 대비 실적, 부서별 분석 리포트</p>
    </div>
</div>

<!-- Report Configuration -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">
            <i data-feather="settings" class="me-2"></i>
            리포트 설정
        </h5>
        <div class="row g-3">
            <div class="col-md-3">
                <label for="reportType" class="form-label">리포트 유형</label>
                <select class="form-select" id="reportType" onchange="onReportTypeChange()">
                    <option value="cashflow">현금흐름 분석</option>
                    <option value="department">부서별 지출 분석</option>
                    <option value="vendor">거래처별 분석</option>
                    <option value="category">카테고리별 분석</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="periodType" class="form-label">기간 설정</label>
                <select class="form-select" id="periodType" onchange="onPeriodTypeChange()">
                    <option value="thisyear">올해 (1월 1일 ~ 현재)</option>
                    <option value="custom">사용자 지정 기간</option>
                </select>
            </div>
            <div class="col-md-2" id="customPeriodStart" style="display: none;">
                <label for="startDate" class="form-label">시작일</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-2" id="customPeriodEnd" style="display: none;">
                <label for="endDate" class="form-label">종료일</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-2">
                <label for="aggregation" class="form-label">집계 단위</label>
                <select class="form-select" id="aggregation">
                    <option value="daily">일별</option>
                    <option value="weekly">주별</option>
                    <option value="monthly" selected>월별</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary d-block w-100" onclick="generateReport()">
                    <i data-feather="refresh-cw" class="me-1"></i>리포트 생성
                </button>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="d-flex justify-content-end">
                    <button class="btn btn-outline-secondary me-2" onclick="exportReport('csv')">
                        <i data-feather="file" class="me-1"></i>CSV 내보내기
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportReport('excel')">
                        <i data-feather="grid" class="me-1"></i>Excel 내보내기
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Report Content -->
<div id="reportContainer">
    <!-- Current report will be displayed here -->
    <div class="alert alert-info text-center">
        <i data-feather="bar-chart-2" class="me-2"></i>
        리포트 유형과 기간을 선택한 후 "리포트 생성" 버튼을 클릭하세요.
    </div>
</div>

<!-- Cash Flow Report Template -->
<div class="report-template" id="cashflowTemplate" style="display: none;">
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="trending-up" class="me-2"></i>
                        현금흐름 추이
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="dollar-sign" class="me-2"></i>
                        월별 요약
                    </h5>
                </div>
                <div class="card-body">
                    
                    {% set ns = namespace(total_income=0, total_expense=0) %}
                    {% for item in monthly_flow %}
                        {% set ns.total_income = ns.total_income + item.income %}
                        {% set ns.total_expense = ns.total_expense + item.expense %}
                    {% endfor %}
                    
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">총 수입</span>
                            <strong class="text-success">₩{{ "{:,.0f}".format(ns.total_income) }}</strong>
                        </div>
                    </div>
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">총 지출</span>
                            <strong class="text-danger">₩{{ "{:,.0f}".format(ns.total_expense | abs) }}</strong>
                        </div>
                    </div>
                    <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">순현금흐름</span>
                            {% set net_flow = ns.total_income + ns.total_expense %}
                            <strong class="{% if net_flow > 0 %}text-success{% elif net_flow < 0 %}text-danger{% else %}text-muted{% endif %}">
                                ₩{{ "{:,.0f}".format(net_flow) }}
                            </strong>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">평균 월 지출</span>
                            {% set avg_expense = (ns.total_expense / (monthly_flow | length if monthly_flow | length > 0 else 1)) | abs %}
                            <strong>₩{{ "{:,.0f}".format(avg_expense) }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department Spending Report Template -->
<div class="report-template" id="departmentTemplate" style="display: none;">
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="users" class="me-2"></i>
                        부서별 지출 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="list" class="me-2"></i>
                        부서별 상세 내역
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0" id="departmentTable">
                            <thead class="table-light">
                                <tr>
                                    <th>부서명</th>
                                    <th>거래 건수</th>
                                    <th class="text-end">총 지출</th>
                                    <th class="text-end">평균 지출</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vendor Analysis Report Template -->
<div class="report-template" id="vendorTemplate" style="display: none;">
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="briefcase" class="me-2"></i>
                        거래처별 지출 현황
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0" id="vendorTable">
                            <thead class="table-light">
                                <tr>
                                    <th>순위</th>
                                    <th>거래처</th>
                                    <th>거래횟수</th>
                                    <th class="text-end">총 금액</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="pie-chart" class="me-2"></i>
                        상위 거래처 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="vendorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Analysis Report Template -->
<div class="report-template" id="categoryTemplate" style="display: none;">
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="tag" class="me-2"></i>
                        카테고리별 지출 분포
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="list" class="me-2"></i>
                        카테고리별 상세 내역
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0" id="categoryTable">
                            <thead class="table-light">
                                <tr>
                                    <th>카테고리</th>
                                    <th>거래 건수</th>
                                    <th class="text-end">총 지출</th>
                                    <th class="text-end">비율</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>부서</th>
                                <th class="text-end">예산</th>
                                <th class="text-end">실적</th>
                                <th class="text-end">차이</th>
                                <th class="text-center">달성률</th>
                                <th class="text-center">상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in dept_spending %}
                            {% set budget = 10000000 %}  <!-- 샘플 예산 -->
                            {% set actual = dept.total | abs %}
                            {% set diff = budget - actual %}
                            {% set rate = (actual / budget * 100) if budget > 0 else 0 %}
                            <tr>
                                <td>{{ dept.name }}</td>
                                <td class="text-end">₩{{ "{:,.0f}".format(budget) }}</td>
                                <td class="text-end text-danger">₩{{ "{:,.0f}".format(actual) }}</td>
                                <td class="text-end {% if diff > 0 %}text-success{% elif diff < 0 %}text-danger{% else %}text-muted{% endif %}">₩{{ "{:,.0f}".format(diff) }}</td>
                                <td class="text-center">
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar {% if rate > 100 %}bg-danger{% elif rate > 90 %}bg-warning{% else %}bg-success{% endif %}" 
                                             style="width: {{ [rate, 100] | min }}%">
                                            {{ "%.1f" | format(rate) }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if rate > 100 %}
                                        <span class="badge bg-danger">초과</span>
                                    {% elif rate > 90 %}
                                        <span class="badge bg-warning">주의</span>
                                    {% else %}
                                        <span class="badge bg-success">양호</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    부서별 지출 데이터가 없습니다.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contract Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="file-text" class="me-2"></i>
                    계약 관점 분석
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i data-feather="info" class="me-2"></i>
                    계약 데이터와 관련 지출을 연계하여 분석합니다. 계약 만료 임박 알림 기능도 포함됩니다.
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="text-primary">12건</h4>
                                <p class="mb-0">활성 계약</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="text-warning">3건</h4>
                                <p class="mb-0">만료 임박 (30일 이내)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="text-success">85%</h4>
                                <p class="mb-0">계약 이행률</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 전역 차트 변수들
let currentChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
});

function initializePage() {
    // 페이지 로드시 기본 설정
    setDefaultDates();
    feather.replace();
}

function setDefaultDates() {
    // 올해 1월 1일 설정
    const today = new Date();
    const startOfYear = new Date(today.getFullYear(), 0, 1);
    
    document.getElementById('startDate').value = startOfYear.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

function onPeriodTypeChange() {
    const periodType = document.getElementById('periodType').value;
    const customStart = document.getElementById('customPeriodStart');
    const customEnd = document.getElementById('customPeriodEnd');
    
    if (periodType === 'custom') {
        customStart.style.display = 'block';
        customEnd.style.display = 'block';
    } else {
        customStart.style.display = 'none';
        customEnd.style.display = 'none';
        // 올해 1월 1일부터 현재까지 설정
        setDefaultDates();
    }
}

function onReportTypeChange() {
    // 리포트 유형이 변경되면 기존 리포트 숨기기
    hideAllReports();
}

function hideAllReports() {
    document.getElementById('reportContainer').innerHTML = `
        <div class="alert alert-info text-center">
            <i data-feather="bar-chart-2" class="me-2"></i>
            리포트 유형과 기간을 선택한 후 "리포트 생성" 버튼을 클릭하세요.
        </div>
    `;
    feather.replace();
}

function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const periodType = document.getElementById('periodType').value;
    const aggregation = document.getElementById('aggregation').value;
    
    let startDate, endDate;
    
    if (periodType === 'custom') {
        startDate = document.getElementById('startDate').value;
        endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            showToast('시작일과 종료일을 모두 선택해주세요.', 'warning');
            return;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
            showToast('시작일은 종료일보다 이전이어야 합니다.', 'warning');
            return;
        }
    } else {
        // 올해 1월 1일부터 현재까지
        const today = new Date();
        const startOfYear = new Date(today.getFullYear(), 0, 1);
        startDate = startOfYear.toISOString().split('T')[0];
        endDate = today.toISOString().split('T')[0];
    }
    
    showToast('리포트를 생성하고 있습니다...', 'info');
    
    // 서버에 AJAX 요청
    const params = new URLSearchParams({
        type: reportType,
        start_date: startDate,
        end_date: endDate,
        aggregation: aggregation
    });
    
    fetch(`/reports/data?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReport(reportType, data.data, startDate, endDate, aggregation);
                showToast('리포트가 생성되었습니다.', 'success');
            } else {
                showToast(`리포트 생성 실패: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('리포트 생성 중 오류가 발생했습니다.', 'danger');
        });
}

function displayReport(reportType, data, startDate, endDate, aggregation) {
    // 기존 차트 파괴
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
    
    // 리포트 컨테이너에 적절한 템플릿 표시
    const container = document.getElementById('reportContainer');
    const template = document.getElementById(reportType + 'Template');
    
    if (template) {
        container.innerHTML = template.innerHTML;
        feather.replace();
        
        // 리포트 유형에 따라 차트/테이블 생성
        switch(reportType) {
            case 'cashflow':
                createCashflowChart(data.cashflow || []);
                break;
            case 'department':
                createDepartmentChart(data.department || []);
                createDepartmentTable(data.department || []);
                break;
            case 'vendor':
                createVendorTable(data.vendor || []);
                createVendorChart(data.vendor || []);
                break;
            case 'category':
                createCategoryChart(data.category || []);
                createCategoryTable(data.category || []);
                break;
        }
    } else {
        container.innerHTML = `
            <div class="alert alert-warning text-center">
                <i data-feather="alert-triangle" class="me-2"></i>
                선택한 리포트 유형에 대한 템플릿을 찾을 수 없습니다.
            </div>
        `;
        feather.replace();
    }
}

function createCashflowChart(data) {
    const ctx = document.getElementById('cashflowChart');
    if (!ctx || data.length === 0) return;
    
    const labels = data.map(item => item.period);
    const incomeData = data.map(item => item.income);
    const expenseData = data.map(item => item.expense);
    const netData = data.map(item => item.net);
    
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '수입',
                data: incomeData,
                borderColor: 'rgb(40, 167, 69)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.1
            }, {
                label: '지출',
                data: expenseData,
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.1
            }, {
                label: '순현금흐름',
                data: netData,
                borderColor: 'rgb(0, 123, 255)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + '원';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '원';
                        }
                    }
                }
            }
        }
    });
}

function createDepartmentChart(data) {
    const ctx = document.getElementById('departmentChart');
    if (!ctx || data.length === 0) return;
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => item.name),
            datasets: [{
                data: data.map(item => item.total),
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ₩' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function createDepartmentTable(data) {
    const tableBody = document.querySelector('#departmentTable tbody');
    if (!tableBody) return;
    
    if (data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-3">
                    선택한 기간에 부서별 데이터가 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    data.forEach(dept => {
        const average = dept.count > 0 ? dept.total / dept.count : 0;
        html += `
            <tr>
                <td>${dept.name}</td>
                <td>${dept.count}건</td>
                <td class="text-end text-danger">₩${dept.total.toLocaleString()}</td>
                <td class="text-end">₩${average.toLocaleString()}</td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}

function createVendorTable(data) {
    const tableBody = document.querySelector('#vendorTable tbody');
    if (!tableBody) return;
    
    if (data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-3">
                    선택한 기간에 거래처별 데이터가 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    data.forEach((vendor, index) => {
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>${vendor.name}</td>
                <td>${vendor.count}회</td>
                <td class="text-end text-danger">₩${vendor.total.toLocaleString()}</td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}

function createVendorChart(data) {
    const ctx = document.getElementById('vendorChart');
    if (!ctx || data.length === 0) return;
    
    const topVendors = data.slice(0, 10); // 상위 10개만
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#AFCBDE', '#FFEB3B'];
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: topVendors.map(item => item.name),
            datasets: [{
                data: topVendors.map(item => item.total),
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ₩' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function createCategoryChart(data) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx || data.length === 0) return;
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => item.name),
            datasets: [{
                data: data.map(item => item.total),
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ₩' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

function createCategoryTable(data) {
    const tableBody = document.querySelector('#categoryTable tbody');
    if (!tableBody) return;
    
    if (data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-3">
                    선택한 기간에 카테고리별 데이터가 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    const total = data.reduce((sum, item) => sum + item.total, 0);
    let html = '';
    data.forEach(category => {
        const percentage = total > 0 ? (category.total / total * 100).toFixed(1) : 0;
        html += `
            <tr>
                <td>${category.name}</td>
                <td>${category.count}건</td>
                <td class="text-end text-danger">₩${category.total.toLocaleString()}</td>
                <td class="text-end">${percentage}%</td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}

// 유틸리티 함수들
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function exportReport(format) {
    const reportType = document.getElementById('reportType').value;
    const periodType = document.getElementById('periodType').value;
    const aggregation = document.getElementById('aggregation').value;
    
    let startDate, endDate;
    
    if (periodType === 'custom') {
        startDate = document.getElementById('startDate').value;
        endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            showToast('시작일과 종료일을 선택한 후 내보내기를 진행해주세요.', 'warning');
            return;
        }
    } else {
        const today = new Date();
        const startOfYear = new Date(today.getFullYear(), 0, 1);
        startDate = startOfYear.toISOString().split('T')[0];
        endDate = today.toISOString().split('T')[0];
    }
    
    showToast(`${format.toUpperCase()} 파일로 내보내는 중...`, 'info');
    
    // 실제 내보내기 기능은 추후 구현
    setTimeout(() => {
        showToast(`${format.toUpperCase()} 내보내기가 완료되었습니다.`, 'success');
    }, 2000);
}

function exportReport(format) {
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const period = document.getElementById('period').value;
    
    // 내보내기 URL 생성
    const params = new URLSearchParams({
        type: reportType,
        start_date: startDate,
        end_date: endDate,
        period: period,
        format: format
    });
    
    showToast(`${format.toUpperCase()} 형식으로 내보내고 있습니다...`, 'info');
    
    // 파일 다운로드
    const url = `/reports/export?${params.toString()}`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `financial_report_${new Date().toISOString().split('T')[0]}.${format}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        showToast('리포트 파일이 다운로드되었습니다.', 'success');
    }, 1000);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// 페이지 로드시 기본 날짜 설정
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    document.getElementById('startDate').value = oneYearAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    // 페이지 로드시 기본 리포트 생성 (약간의 지연)
    setTimeout(() => {
        console.log('Loading default report...');
        generateReport();
    }, 500);
});
</script>
{% endblock %}
