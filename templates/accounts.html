{% extends "layout.html" %}

{% block title %}계정 관리 - 한국형 오픈뱅킹 회계시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">계정 관리</h1>
        <p class="text-muted">연결된 계좌 및 카드 정보 관리</p>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i data-feather="credit-card" class="text-primary mb-2" style="width: 48px; height: 48px;"></i>
                <h4>{{ accounts | selectattr('account_type', 'equalto', 'checking') | list | length }}</h4>
                <p class="text-muted mb-0">입출금 계좌</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i data-feather="dollar-sign" class="text-success mb-2" style="width: 48px; height: 48px;"></i>
                <h4>{{ accounts | selectattr('account_type', 'equalto', 'savings') | list | length }}</h4>
                <p class="text-muted mb-0">예적금 계좌</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i data-feather="credit-card" class="text-warning mb-2" style="width: 48px; height: 48px;"></i>
                <h4>{{ accounts | selectattr('account_type', 'equalto', 'credit') | list | length }}</h4>
                <p class="text-muted mb-0">신용카드</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i data-feather="dollar-sign" class="text-info mb-2" style="width: 48px; height: 48px;"></i>
                <h4>{{ accounts | sum(attribute='balance') | currency }}</h4>
                <p class="text-muted mb-0">총 잔액</p>
            </div>
        </div>
    </div>
</div>

<!-- Accounts List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i data-feather="list" class="me-2"></i>
                    계좌 목록
                </h5>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i data-feather="plus" class="me-2"></i>계좌 추가
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>기본정보</th>
                                <th>계좌유형</th>
                                <th>잔액</th>
                                <th>부서</th>
                                <th>최종 업데이트</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in accounts %}
                            <tr>
                                <td>
                                    <div class="account-info">
                                        <div class="d-flex align-items-center">
                                            {% if account.institution.type == 'bank' %}
                                                <i data-feather="home" class="text-primary me-2"></i>
                                            {% elif account.institution.type == 'card' %}
                                                <i data-feather="credit-card" class="text-warning me-2"></i>
                                            {% else %}
                                                <i data-feather="smartphone" class="text-success me-2"></i>
                                            {% endif %}
                                            <div>
                                                <strong>{{ account.institution.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ account.account_name }}</small>
                                                <br>
                                                <code class="small">{{ account.account_number }}</code>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if account.account_type == 'checking' %}
                                        <span class="badge bg-primary">입출금</span>
                                    {% elif account.account_type == 'savings' %}
                                        <span class="badge bg-success">예적금</span>
                                    {% elif account.account_type == 'credit' %}
                                        <span class="badge bg-warning">신용카드</span>
                                    {% else %}
                                        <span class="badge bg-secondary">기타</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <strong class="{{ account.balance | amount_color }}">
                                        {{ account.balance | currency }}
                                    </strong>
                                    <br>
                                    <small class="text-muted">{{ account.currency }}</small>
                                </td>
                                <td>
                                    {% if account.department %}
                                        <span class="badge bg-info">{{ account.department.name }}</span>
                                    {% else %}
                                        <span class="text-muted">미지정</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ account.updated_at.strftime('%Y-%m-%d') }}
                                    <br>
                                    <small class="text-muted">{{ account.updated_at.strftime('%H:%M') }}</small>
                                </td>
                                <td>
                                    {% if account.is_active %}
                                        <span class="badge bg-success">활성</span>
                                    {% else %}
                                        <span class="badge bg-secondary">비활성</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editAccountModal{{ account.id }}"
                                                title="편집">
                                            <i data-feather="edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" 
                                                onclick="syncAccount({{ account.id }})" 
                                                title="동기화">
                                            <i data-feather="refresh-cw"></i>
                                        </button>
                                        <a href="{{ url_for('transactions', account_id=account.id) }}" 
                                           class="btn btn-outline-secondary" 
                                           title="거래내역">
                                            <i data-feather="list"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    등록된 계좌가 없습니다. 먼저 금융기관을 연결해 주세요.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">계좌 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_account') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="institution" class="form-label">금융기관</label>
                        <select class="form-select" id="institution" name="institution_id" required>
                            <option value="">금융기관을 선택하세요</option>
                            {% for institution in institutions %}
                                <option value="{{ institution.id }}">{{ institution.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountName" class="form-label">계좌명</label>
                        <input type="text" class="form-control" id="accountName" name="account_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountNumber" class="form-label">계좌번호</label>
                        <input type="text" class="form-control" id="accountNumber" name="account_number" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountType" class="form-label">계좌유형</label>
                        <select class="form-select" id="accountType" name="account_type" required>
                            <option value="">선택하세요</option>
                            <option value="checking">입출금</option>
                            <option value="savings">예적금</option>
                            <option value="credit">신용카드</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="department" class="form-label">담당 부서</label>
                        <select class="form-select" id="department" name="department_id">
                            <option value="">선택하세요</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Account Modals for each account -->
{% for account in accounts %}
<div class="modal fade" id="editAccountModal{{ account.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">계좌 정보 수정 - {{ account.account_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_account', account_id=account.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">금융기관</label>
                        <input type="text" class="form-control" value="{{ account.institution.name }}" disabled>
                        <small class="text-muted">금융기관은 변경할 수 없습니다.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editAccountName{{ account.id }}" class="form-label">계좌명</label>
                        <input type="text" class="form-control" id="editAccountName{{ account.id }}" 
                               name="account_name" value="{{ account.account_name }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editAccountNumber{{ account.id }}" class="form-label">계좌번호</label>
                        <input type="text" class="form-control" id="editAccountNumber{{ account.id }}" 
                               name="account_number" value="{{ account.account_number }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editAccountType{{ account.id }}" class="form-label">계좌유형</label>
                        <select class="form-select" id="editAccountType{{ account.id }}" name="account_type" required>
                            <option value="checking" {% if account.account_type == 'checking' %}selected{% endif %}>입출금 계좌</option>
                            <option value="savings" {% if account.account_type == 'savings' %}selected{% endif %}>예적금 계좌</option>
                            <option value="credit" {% if account.account_type == 'credit' %}selected{% endif %}>신용카드</option>
                            <option value="loan" {% if account.account_type == 'loan' %}selected{% endif %}>대출 계좌</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editBalance{{ account.id }}" class="form-label">잔액</label>
                        <input type="number" class="form-control" id="editBalance{{ account.id }}" 
                               name="balance" value="{{ account.balance }}" step="0.01">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editDepartment{{ account.id }}" class="form-label">담당 부서</label>
                        <select class="form-select" id="editDepartment{{ account.id }}" name="department_id">
                            <option value="">부서 미지정</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" 
                                        {% if account.department_id == dept.id %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save" class="me-1"></i>수정 저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
function editAccount(accountId) {
    // 계좌 정보 수정 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
    modal.show();
}

function syncAccount(accountId) {
    // 계좌 동기화
    if (confirm('계좌 정보를 동기화하시겠습니까?')) {
        // 동기화 로직 (실제로는 API 호출)
        showToast('계좌 동기화가 시작되었습니다.', 'info');
    }
}

function showToast(message, type = 'success') {
    // 간단한 토스트 메시지 표시
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}
